{{- if .Values.webhook.enabled }}
{{- $certManagerEnabled := eq (include "controller.certManagerEnabled" .) "true" }}
apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  labels:
    {{- include "controller.labels" . | nindent 4 }}
    app.kubernetes.io/component: webhook
  name: {{ include "controller.fullname" . }}-mutating-webhook-configuration
  {{- if $certManagerEnabled }}
  annotations:
    cert-manager.io/inject-ca-from: {{ include "controller.namespace" . }}/{{ include "controller.webhook.certSecretName" . }}
  {{- end }}
webhooks:
- admissionReviewVersions:
  - v1
  clientConfig:
    service:
      name: {{ include "controller.webhook.serviceName" . }}
      namespace: {{ include "controller.namespace" . }}
      path: /mutate-infra-theriseunion-io-v1alpha1-clusterregistry
      port: {{ .Values.webhook.service.port }}
  failurePolicy: {{ .Values.webhook.admission.failurePolicy }}
  name: mclusterregistry.theriseunion.io
  namespaceSelector:
    matchExpressions:
    {{- range .Values.webhook.namespaceSelector.excludeNamespaces }}
    - key: kubernetes.io/metadata.name
      operator: NotIn
      values:
      - {{ . }}
    {{- end }}
    # Always exclude the controller's own namespace to avoid intercepting its own pods
    - key: kubernetes.io/metadata.name
      operator: NotIn
      values:
      - {{ include "controller.namespace" . }}
  rules:
  - apiGroups:
    - infra.theriseunion.io
    apiVersions:
    - v1alpha1
    operations:
    - CREATE
    resources:
    - clusterregistries
  sideEffects: {{ .Values.webhook.admission.sideEffects }}
  timeoutSeconds: {{ .Values.webhook.admission.timeoutSeconds }}
- admissionReviewVersions:
  - v1
  clientConfig:
    service:
      name: {{ include "controller.webhook.serviceName" . }}
      namespace: {{ include "controller.namespace" . }}
      path: /mutate-infra-theriseunion-io-v1alpha1-registry
      port: {{ .Values.webhook.service.port }}
  failurePolicy: {{ .Values.webhook.admission.failurePolicy }}
  name: mregistry.theriseunion.io
  namespaceSelector:
    matchExpressions:
    {{- range .Values.webhook.namespaceSelector.excludeNamespaces }}
    - key: kubernetes.io/metadata.name
      operator: NotIn
      values:
      - {{ . }}
    {{- end }}
    # Always exclude the controller's own namespace to avoid intercepting its own pods
    - key: kubernetes.io/metadata.name
      operator: NotIn
      values:
      - {{ include "controller.namespace" . }}
  rules:
  - apiGroups:
    - infra.theriseunion.io
    apiVersions:
    - v1alpha1
    operations:
    - CREATE
    resources:
    - registries
  sideEffects: {{ .Values.webhook.admission.sideEffects }}
  timeoutSeconds: {{ .Values.webhook.admission.timeoutSeconds }}
- admissionReviewVersions:
  - v1
  clientConfig:
    service:
      name: {{ include "controller.webhook.serviceName" . }}
      namespace: {{ include "controller.namespace" . }}
      path: /mutate-core-v1-pod
      port: {{ .Values.webhook.service.port }}
  failurePolicy: {{ .Values.webhook.admission.failurePolicy }}
  name: pod.theriseunion.io
  namespaceSelector:
    matchExpressions:
    {{- range .Values.webhook.namespaceSelector.excludeNamespaces }}
    - key: kubernetes.io/metadata.name
      operator: NotIn
      values:
      - {{ . }}
    {{- end }}
    # Always exclude the controller's own namespace to avoid intercepting its own pods
    - key: kubernetes.io/metadata.name
      operator: NotIn
      values:
      - {{ include "controller.namespace" . }}
  objectSelector:
    matchExpressions:
    - key: control-plane
      operator: NotIn
      values:
      - controller-manager
  rules:
  - apiGroups:
    - ""
    apiVersions:
    - v1
    operations:
    - CREATE
    - UPDATE
    resources:
    - pods
  sideEffects: {{ .Values.webhook.admission.sideEffects }}
  timeoutSeconds: {{ .Values.webhook.admission.timeoutSeconds }}
  reinvocationPolicy: {{ .Values.webhook.admission.reinvocationPolicy }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "controller.webhook.serviceName" . }}
  namespace: {{ include "controller.namespace" . }}
  labels:
    {{- include "controller.labels" . | nindent 4 }}
    app.kubernetes.io/component: webhook
  {{- with .Values.webhook.service.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  type: {{ .Values.webhook.service.type }}
  ports:
  - port: {{ .Values.webhook.service.port }}
    protocol: TCP
    targetPort: {{ .Values.webhook.service.targetPort }}
  selector:
    {{- include "controller.selectorLabels" . | nindent 4 }}
{{- end }}
