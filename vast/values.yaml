# Default values for vast.
# This is a YAML-formatted file.

# Global values shared across all subcharts
global:
  # Image pull secrets (applied to all subcharts)
  imagePullSecrets: []
  # Namespace override (if not set, uses Release.Namespace)
  namespaceOverride: ""

# Enable/disable subcharts
apiserver:
  enabled: true
  # Image configuration
  image:
    repository: quanzhenglong.com/edge/apiserver
    tag: vast-v0.1.0-10
    pullPolicy: Always

  # Namespace override (defaults to Release.Namespace)
  namespaceOverride: ""

  # Service configuration
  service:
    type: ClusterIP
    port: 8443
    targetPort: 8443

  # Deployment configuration
  replicaCount: 1

  # Resource limits and requests
  resources:
    limits:
      cpu: 500m
      memory: 256Mi
    requests:
      cpu: 50m
      memory: 128Mi

  # Environment variables
  env:
    - name: PORT
      value: "8443"
    - name: CAMP_NS
      value: "rise-vast-system"

  # Configuration for apiserver.yaml ConfigMap
  config:
    # Server configuration
    server:
      port: 8090
      host: "0.0.0.0"
      timeout:
        read: "30s"
        write: "30s"
        idle: "120s"
      tls:
        enabled: false
        certFile: "/tmp/k8s-webhook-server/serving-certs/tls.crt"
        keyFile: "/tmp/k8s-webhook-server/serving-certs/tls.key"

    # Authentication configuration
    auth:
      mode: "RBAC" # RBAC or AlwaysAllow
      jwt:
        secret: "" # Should be set via environment variable JWT_SECRET in production
        expiry: "24h"
        refreshTTL: "168h" # 7 days
      oauth:
        issuer: ""
        clientId: ""
        clientSecret: ""

    # Metrics configuration
    metrics:
      enabled: true
      prometheus:
        endpoint: "http://prometheus-kube-prometheus-prometheus.prometheus.svc.cluster.local:9090"
        auth: ""
        timeout: "30s"
        maxConcurrentQueries: 10
        retryCount: 3
        retryInterval: "1s"
        tlsInsecureSkipVerify: true
      cache:
        enabled: true
        ttl: "30s"
        size: 1000

    # Logging configuration
    logging:
      level: "info" # debug, info, warn, error
      format: "text" # text, json
      output: "stdout" # stdout, stderr, file
      file: "/var/log/apiserver/apiserver.log"
      rotation:
        maxSize: 100 # MB
        maxBackups: 5
        maxAge: 30 # days
        compress: true

    # Database configuration (optional)
    database:
      type: "" # mysql, postgres, sqlite
      host: ""
      port: 0
      database: ""
      username: ""
      password: "" # Should be set via environment variable in production
      sslMode: ""

    # Device manager configuration
    deviceManager:
      enabledAggregator: true
      hamiDeviceConfig: "config/device.yaml"

  # Certificate configuration
  cert:
    secretName: apiserver-cert
    create: false

controller:
  enabled: true
  # Image configuration
  image:
    repository: quanzhenglong.com/edge/controller
    tag: vast-v0.1.0-10
    pullPolicy: Always

  # Kube RBAC Proxy configuration
  kubeRbacProxy:
    enabled: true
    image:
      repository: quanzhenglong.com/edge/kube-rbac-proxy
      tag: v0.15.0
      pullPolicy: IfNotPresent
    resources:
      limits:
        cpu: 500m
        memory: 128Mi
      requests:
        cpu: 5m
        memory: 64Mi
    args:
      - --secure-listen-address=0.0.0.0:8443
      - --upstream=http://127.0.0.1:8080/
      - --logtostderr=true
      - --v=0
    port: 8443

  # Namespace override (defaults to Release.Namespace)
  namespaceOverride: ""

  # Deployment configuration
  replicaCount: 1

  # Resource limits and requests
  resources:
    limits:
      cpu: 500m
      memory: 128Mi
    requests:
      cpu: 10m
      memory: 64Mi

  # Environment variables
  env:
    - name: ENABLE_WEBHOOKS
      value: "true"
    - name: WEBHOOK_PORT
      value: "9443"
    - name: CAMP_NS
      value: "rise-vast-system"

  # Webhook configuration
  webhook:
    port: 9443
    certSecretName: webhook-server-cert
    certCreate: false

  # Configuration for controller.yaml ConfigMap
  config:
    # Metrics configuration
    metrics:
      enabled: true
      prometheus:
        endpoint: "http://10.100.121.67:30190/"
        auth: ""
        timeout: "30s"
        maxConcurrentQueries: 10
        retryCount: 3
        retryInterval: "1s"
        tlsInsecureSkipVerify: true

    # Device manager configuration
    deviceManager:
      hamiDeviceConfig: "config/device.yaml"

    # Device plugin configuration
    devicePlugin:
      nvidia-hami:
        mem_factor: 1
        node_label:
          key: gpu-test
          value: "on"
      hygon-hami:
        mem_factor: 1
        node_label:
          key: dcu-test
          value: "on"
      cambricon-hami:
        mem_factor: 1
        node_label:
          key: mlu-test
          value: "on"
      kunlunxin-hami:
        mem_factor: 1
        node_label:
          key: xpu-test
          value: "on"
      ascend-hami:
        mem_factor: 1
        node_label:
          key: ascend-test
          value: "on"
      iluvatar-hami:
        mem_factor: 256
        node_label:
          key: iluvatar-test
          value: "on"
      metax-hami:
        mem_factor: 1
        node_label:
          key: metax-test
          value: "on"
      enflame-hami:
        mem_factor: 1
        node_label:
          key: gcu-test
          value: "on"
      alibaba-hami:
        mem_factor: 1
        node_label:
          key: ppu-test
          value: "on"
      nvidia-volcano:
        mem_factor: 10
        node_label:
          key: volcano
          value: "on"
      ascend-volcano:
        mem_factor: 1
        node_label:
          key: volcano_ascend-test
          value: "on"

# HAMI subchart configuration
hami:
  enabled: true
  fullnameOverride: hami
  version: "v1.6.1-rc-08"
  # Disable ServiceMonitor by default if Prometheus Operator is not installed
  # Set to true if you have Prometheus Operator installed
  devicePlugin:
    serviceMonitor:
      enabled: false
  exporter:
    kunlunxin:
      serviceMonitor:
        enabled: false
    enflame:
      serviceMonitor:
        enabled: false
  scheduler:
    # nodeSelector:
    #   theriseunion.io/control: "true"
    tolerations:
      - key: node-role.kubernetes.io/control-plane
        operator: Exists
        effect: NoSchedule
    kubeScheduler:
      imageTag: "v1.34.0"
      image: quanzhenglong.com/camp/kubesphere/kube-scheduler
    extender:
      image: quanzhenglong.com/camp/hami
    patch:
      image: quanzhenglong.com/camp/jettech-kube-webhook-certgen:v1.5.2
      imageNew: quanzhenglong.com/camp/liangjw-kube-webhook-certgen:v1.1.1
      # nodeSelector:
      #   theriseunion.io/control: "true"
      tolerations:
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule
