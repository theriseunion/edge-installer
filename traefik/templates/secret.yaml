{{- if .Values.tls.enabled }}
{{- $existingSecret := lookup "v1" "Secret" (include "traefik.namespace" .) (printf "%s-default-cert" (include "traefik.fullname" .)) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "traefik.fullname" . }}-default-cert
  namespace: {{ include "traefik.namespace" . }}
  labels:
    {{- include "traefik.labels" . | nindent 4 }}
  annotations:
    helm.sh/resource-policy: keep
type: kubernetes.io/tls
data:
  {{- if and $existingSecret $existingSecret.data }}
  # Reuse existing certificate to maintain consistency across upgrades
  tls.crt: {{ index $existingSecret.data "tls.crt" }}
  tls.key: {{ index $existingSecret.data "tls.key" }}
  {{- else if .Values.tls.autogenerate }}
  # Generate self-signed certificate dynamically
  {{- $altNames := list }}
  {{- $altNames = append $altNames "*.local" }}
  {{- $altNames = append $altNames "*.vcluster.local" }}
  {{- $altNames = append $altNames (printf "traefik.%s.svc.cluster.local" (include "traefik.namespace" .)) }}
  {{- $altNames = append $altNames (printf "traefik.%s.svc" (include "traefik.namespace" .)) }}
  {{- $altNames = append $altNames "traefik" }}
  {{- $altNames = append $altNames "localhost" }}
  {{- $altIPs := list }}
  {{- $altIPs = append $altIPs "127.0.0.1" }}
  {{- if .Values.tls.extraIPs }}
  {{- range .Values.tls.extraIPs }}
  {{- $altIPs = append $altIPs . }}
  {{- end }}
  {{- end }}
  {{- $ca := genCA "Traefik CA" 3650 }}
  {{- $cert := genSignedCert "*.local" $altIPs $altNames 3650 $ca }}
  tls.crt: {{ $cert.Cert | b64enc }}
  tls.key: {{ $cert.Key | b64enc }}
  {{- else if and .Values.tls.certificate.crt .Values.tls.certificate.key }}
  # Use provided certificate
  tls.crt: {{ .Values.tls.certificate.crt | b64enc }}
  tls.key: {{ .Values.tls.certificate.key | b64enc }}
  {{- else }}
  # Fallback: Generate self-signed certificate
  {{- $ca := genCA "Traefik CA" 3650 }}
  {{- $cert := genSignedCert "*.local" nil (list "*.local" "localhost") 3650 $ca }}
  tls.crt: {{ $cert.Cert | b64enc }}
  tls.key: {{ $cert.Key | b64enc }}
  {{- end }}
{{- end }}
