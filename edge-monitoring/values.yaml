# Edge 监控套件配置
# 可选择性安装 Prometheus/Grafana/AlertManager

# 全局配置
global:
  # 是否启用监控套件
  enabled: true
  # 命名空间
  namespace: edge-system

# Prometheus 配置
prometheus:
  enabled: true
  image:
    repository: prom/prometheus
    tag: v2.45.0
    pullPolicy: IfNotPresent

  service:
    type: ClusterIP
    port: 9090

  # 存储配置
  persistence:
    enabled: true
    size: 20Gi
    storageClassName: ""

  # 资源限制
  resources:
    requests:
      memory: "512Mi"
      cpu: "250m"
    limits:
      memory: "1Gi"
      cpu: "500m"

  # 配置文件
  config:
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
    rule_files:
      - "/etc/prometheus/rules/*.yml"
    scrape_configs:
      - job_name: 'edge-apiserver'
        static_configs:
          - targets: ['edge-apiserver:8083']
        metrics_path: '/metrics'
      - job_name: 'edge-controller'
        static_configs:
          - targets: ['edge-controller:8082']
        metrics_path: '/metrics'
      - job_name: 'kubernetes-pods'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: true

# Grafana 配置
grafana:
  enabled: true
  image:
    repository: grafana/grafana
    tag: 10.0.0
    pullPolicy: IfNotPresent

  service:
    type: ClusterIP
    port: 3000

  # 默认管理员密码
  adminPassword: admin123

  # 持久化存储
  persistence:
    enabled: true
    size: 10Gi
    storageClassName: ""

  # 资源限制
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "200m"

  # 数据源配置
  datasources:
    - name: Prometheus
      type: prometheus
      url: http://edge-prometheus:9090
      access: proxy
      isDefault: true

# AlertManager 配置
alertmanager:
  enabled: true
  image:
    repository: prom/alertmanager
    tag: v0.25.0
    pullPolicy: IfNotPresent

  service:
    type: ClusterIP
    port: 9093

  # 资源限制
  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "128Mi"
      cpu: "100m"

  # 告警配置
  config:
    global:
      smtp_smarthost: 'localhost:587'
      smtp_from: 'alertmanager@edge.local'
    route:
      group_by: ['alertname']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 1h
      receiver: 'web.hook'
    receivers:
      - name: 'web.hook'
        webhook_configs:
          - url: 'http://127.0.0.1:5001/'

# ServiceMonitor 配置 - 自动发现服务
serviceMonitor:
  enabled: true
  # 为 edge 组件创建 ServiceMonitor
  targets:
    - name: edge-apiserver
      service: edge-apiserver
      port: metrics
      path: /metrics
    - name: edge-controller
      service: edge-controller
      port: metrics
      path: /metrics