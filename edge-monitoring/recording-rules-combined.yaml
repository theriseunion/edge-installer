# ========================================================================
# Combined Prometheus Recording Rules
# Auto-generated from modular PrometheusRule files
#
# DO NOT EDIT THIS FILE DIRECTLY!
# Edit individual files in rules/ directory and regenerate using:
#   python3 generate-combined-rules.py
#
# Source files (in priority order):
# - node-recording-rules.yaml
# - gpu-recording-rules.yaml
# - nodegroup-recording-rules.yaml
# - cluster-recording-rules.yaml
# - workspace-recording-rules.yaml
# - namespace-recording-rules.yaml
# - npu-recording-rules.yaml
# ========================================================================

groups:
- name: node-cpu-metrics
  interval: 30s
  rules:
  - record: node_cpu_total
    expr: |-
      count by (cluster, instance) (
        node_cpu_seconds_total{job="node-exporter", mode="idle"}
      )
  - record: node_cpu_usage
    expr: |-
      sum by (cluster, instance) (
        rate(node_cpu_seconds_total{job="node-exporter", mode!="idle"}[5m])
      )
  - record: node_cpu_utilisation
    expr: |-
      node_cpu_usage / node_cpu_total
  - record: node_cpu_allocatable_total
    expr: |-
      kube_node_status_allocatable{job="kube-state-metrics", resource="cpu"}
- name: node-memory-metrics
  interval: 30s
  rules:
  - record: node_memory_total
    expr: |-
      node_memory_MemTotal_bytes{job="node-exporter"}
  - record: node_memory_available
    expr: |-
      node_memory_MemAvailable_bytes{job="node-exporter"}
  - record: node_memory_usage
    expr: |-
      node_memory_MemTotal_bytes{job="node-exporter"}
      -
      node_memory_MemAvailable_bytes{job="node-exporter"}
  - record: node_memory_utilisation
    expr: |-
      node_memory_usage / node_memory_total
  - record: node_memory_allocatable_total
    expr: |-
      kube_node_status_allocatable{job="kube-state-metrics", resource="memory"}
- name: node-disk-metrics
  interval: 30s
  rules:
  - record: node_disk_size_capacity
    expr: |-
      sum by (cluster, instance) (
        node_filesystem_size_bytes{job="node-exporter", mountpoint="/", fstype!~"tmpfs|fuse.*"}
      )
  - record: node_disk_size_available
    expr: |-
      sum by (cluster, instance) (
        node_filesystem_avail_bytes{job="node-exporter", mountpoint="/", fstype!~"tmpfs|fuse.*"}
      )
  - record: node_disk_size_usage
    expr: |-
      node_disk_size_capacity - node_disk_size_available
  - record: node_disk_inode_total
    expr: |-
      sum by (cluster, instance) (
        node_filesystem_files{job="node-exporter", mountpoint="/", fstype!~"tmpfs|fuse.*"}
      )
  - record: node_disk_inode_usage
    expr: |-
      sum by (cluster, instance) (
        node_filesystem_files{job="node-exporter", mountpoint="/", fstype!~"tmpfs|fuse.*"}
        -
        node_filesystem_files_free{job="node-exporter", mountpoint="/", fstype!~"tmpfs|fuse.*"}
      )
  - record: node_ephemeral_storage_allocatable_total
    expr: |-
      kube_node_status_allocatable{job="kube-state-metrics", resource="ephemeral-storage"}
- name: node-pod-metrics
  interval: 30s
  rules:
  - record: node_pod_count
    expr: |-
      count by (cluster, node) (
        kube_pod_info{job="kube-state-metrics"}
      )
  - record: node_pod_quota
    expr: |-
      kube_node_status_allocatable{job="kube-state-metrics", resource="pods"}
  - record: node_pod_requests_cpu_total
    expr: |-
      sum by (cluster, node) (
        kube_pod_container_resource_requests{job="kube-state-metrics", resource="cpu"}
        * on(cluster, namespace, pod) group_left(node)
        kube_pod_info{job="kube-state-metrics"}
      )
  - record: node_pod_limits_cpu_total
    expr: |-
      sum by (cluster, node) (
        kube_pod_container_resource_limits{job="kube-state-metrics", resource="cpu"}
        * on(cluster, namespace, pod) group_left(node)
        kube_pod_info{job="kube-state-metrics"}
      )
  - record: node_pod_requests_memory_total
    expr: |-
      sum by (cluster, node) (
        kube_pod_container_resource_requests{job="kube-state-metrics", resource="memory"}
        * on(cluster, namespace, pod) group_left(node)
        kube_pod_info{job="kube-state-metrics"}
      )
  - record: node_pod_limits_memory_total
    expr: |-
      sum by (cluster, node) (
        kube_pod_container_resource_limits{job="kube-state-metrics", resource="memory"}
        * on(cluster, namespace, pod) group_left(node)
        kube_pod_info{job="kube-state-metrics"}
      )
  - record: node_pod_requests_ephemeral_storage_total
    expr: |-
      sum by (cluster, node) (
        kube_pod_container_resource_requests{job="kube-state-metrics", resource="ephemeral-storage"}
        * on(cluster, namespace, pod) group_left(node)
        kube_pod_info{job="kube-state-metrics"}
      )
- name: container-gpu-metrics
  interval: 30s
  rules:
  - record: container_gpu_usage
    expr: |-
      DCGM_FI_DEV_GPU_UTIL
      * on(uuid) group_left(pod, namespace, container)
      label_replace(
        kube_pod_container_info{container!="POD"},
        "uuid", "$1", "pod", ".*-([a-f0-9\\-]+)$"
      )
  - record: container_gpu_memory_usage
    expr: |-
      DCGM_FI_DEV_FB_USED * 1024 * 1024
      * on(uuid) group_left(pod, namespace, container)
      label_replace(
        kube_pod_container_info{container!="POD"},
        "uuid", "$1", "pod", ".*-([a-f0-9\\-]+)$"
      )
- name: node-gpu-metrics
  interval: 30s
  rules:
  - record: node_gpu_memory_total
    expr: |-
      sum by (cluster, instance) (
        DCGM_FI_DEV_FB_TOTAL * 1024 * 1024
      )
  - record: node_gpu_memory_usage
    expr: |-
      sum by (cluster, instance) (
        DCGM_FI_DEV_FB_USED * 1024 * 1024
      )
  - record: node_gpu_count
    expr: |-
      count by (cluster, instance) (
        DCGM_FI_DEV_FB_TOTAL
      )
  - record: node_gpu_utilisation_avg
    expr: |-
      avg by (cluster, instance) (
        DCGM_FI_DEV_GPU_UTIL
      )
  - record: node_gpu_temperature_avg
    expr: |-
      avg by (cluster, instance) (
        DCGM_FI_DEV_GPU_TEMP
      )
  - record: node_gpu_power_total
    expr: |-
      sum by (cluster, instance) (
        DCGM_FI_DEV_POWER_USAGE
      )
- name: nodegroup-aggregation-rules
  interval: 30s
  rules:
  - record: nodegroup:kube_node_info:count
    expr: |-
      count by (cluster, nodegroup) (
        kube_node_info{job="kube-state-metrics"}
        * on(node) group_left(nodegroup)
        label_replace(
          kube_node_labels{label_theriseunion_io_nodegroup!=""},
          "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
        )
      )
  - record: nodegroup:node_cpu_usage:sum_rate
    expr: |-
      sum by (cluster, nodegroup) (
        (1 - avg by (cluster, instance) (irate(node_cpu_seconds_total{job="node-exporter",mode="idle"}[5m])))
        * on(instance) group_left(node)
        label_replace(kube_node_info{job="kube-state-metrics"}, "instance", "$1", "node", "(.*)")
        * on(node) group_left(nodegroup)
        label_replace(
          kube_node_labels{label_theriseunion_io_nodegroup!=""},
          "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
        )
      )
  - record: nodegroup:machine_cpu_cores:sum
    expr: |-
      sum by (cluster, nodegroup) (
        machine_cpu_cores
        * on(instance) group_left(node)
        label_replace(kube_node_info{job="kube-state-metrics"}, "instance", "$1", "node", "(.*)")
        * on(node) group_left(nodegroup)
        label_replace(
          kube_node_labels{label_theriseunion_io_nodegroup!=""},
          "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
        )
      )
  - record: nodegroup:node_memory_usage_bytes:sum
    expr: |-
      sum by (cluster, nodegroup) (
        (node_memory_MemTotal_bytes{job="node-exporter"} - node_memory_MemAvailable_bytes{job="node-exporter"})
        * on(instance) group_left(node)
        label_replace(kube_node_info{job="kube-state-metrics"}, "instance", "$1", "node", "(.*)")
        * on(node) group_left(nodegroup)
        label_replace(
          kube_node_labels{label_theriseunion_io_nodegroup!=""},
          "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
        )
      )
  - record: nodegroup:node_memory_available_bytes:sum
    expr: |-
      sum by (cluster, nodegroup) (
        node_memory_MemAvailable_bytes{job="node-exporter"}
        * on(instance) group_left(node)
        label_replace(kube_node_info{job="kube-state-metrics"}, "instance", "$1", "node", "(.*)")
        * on(node) group_left(nodegroup)
        label_replace(
          kube_node_labels{label_theriseunion_io_nodegroup!=""},
          "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
        )
      )
  - record: nodegroup:node_memory_total_bytes:sum
    expr: |-
      sum by (cluster, nodegroup) (
        node_memory_MemTotal_bytes{job="node-exporter"}
        * on(instance) group_left(node)
        label_replace(kube_node_info{job="kube-state-metrics"}, "instance", "$1", "node", "(.*)")
        * on(node) group_left(nodegroup)
        label_replace(
          kube_node_labels{label_theriseunion_io_nodegroup!=""},
          "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
        )
      )
  - record: nodegroup:node_network_receive_bytes:sum_rate
    expr: |-
      sum by (cluster, nodegroup) (
        irate(node_network_receive_bytes_total{job="node-exporter",device!~"lo|veth.*|docker.*|br.*"}[5m])
        * on(instance) group_left(node)
        label_replace(kube_node_info{job="kube-state-metrics"}, "instance", "$1", "node", "(.*)")
        * on(node) group_left(nodegroup)
        label_replace(
          kube_node_labels{label_theriseunion_io_nodegroup!=""},
          "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
        )
      )
  - record: nodegroup:node_network_transmit_bytes:sum_rate
    expr: |-
      sum by (cluster, nodegroup) (
        irate(node_network_transmit_bytes_total{job="node-exporter",device!~"lo|veth.*|docker.*|br.*"}[5m])
        * on(instance) group_left(node)
        label_replace(kube_node_info{job="kube-state-metrics"}, "instance", "$1", "node", "(.*)")
        * on(node) group_left(nodegroup)
        label_replace(
          kube_node_labels{label_theriseunion_io_nodegroup!=""},
          "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
        )
      )
  - record: nodegroup:node_network_receive_packets:sum_rate
    expr: |-
      sum by (cluster, nodegroup) (
        irate(node_network_receive_packets_total{job="node-exporter",device!~"lo|veth.*|docker.*|br.*"}[5m])
        * on(instance) group_left(node)
        label_replace(kube_node_info{job="kube-state-metrics"}, "instance", "$1", "node", "(.*)")
        * on(node) group_left(nodegroup)
        label_replace(
          kube_node_labels{label_theriseunion_io_nodegroup!=""},
          "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
        )
      )
  - record: nodegroup:node_network_transmit_packets:sum_rate
    expr: |-
      sum by (cluster, nodegroup) (
        irate(node_network_transmit_packets_total{job="node-exporter",device!~"lo|veth.*|docker.*|br.*"}[5m])
        * on(instance) group_left(node)
        label_replace(kube_node_info{job="kube-state-metrics"}, "instance", "$1", "node", "(.*)")
        * on(node) group_left(nodegroup)
        label_replace(
          kube_node_labels{label_theriseunion_io_nodegroup!=""},
          "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
        )
      )
  - record: nodegroup:node_filesystem_usage_bytes:sum
    expr: |-
      sum by (cluster, nodegroup) (
        max by (cluster, instance, device) (
          (node_filesystem_size_bytes{job="node-exporter",fstype!~"virtiofs|tmpfs|overlay|rootfs|squashfs|fuse.*"}
           - node_filesystem_avail_bytes{job="node-exporter",fstype!~"virtiofs|tmpfs|overlay|rootfs|squashfs|fuse.*"})
        )
        * on(instance) group_left(node)
        label_replace(kube_node_info{job="kube-state-metrics"}, "instance", "$1", "node", "(.*)")
        * on(node) group_left(nodegroup)
        label_replace(
          kube_node_labels{label_theriseunion_io_nodegroup!=""},
          "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
        )
      )
  - record: nodegroup:node_filesystem_available_bytes:sum
    expr: |-
      sum by (cluster, nodegroup) (
        max by (cluster, instance, device) (
          node_filesystem_avail_bytes{job="node-exporter",fstype!~"virtiofs|tmpfs|overlay|rootfs|squashfs|fuse.*"}
        )
        * on(instance) group_left(node)
        label_replace(kube_node_info{job="kube-state-metrics"}, "instance", "$1", "node", "(.*)")
        * on(node) group_left(nodegroup)
        label_replace(
          kube_node_labels{label_theriseunion_io_nodegroup!=""},
          "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
        )
      )
  - record: nodegroup:node_filesystem_total_bytes:sum
    expr: |-
      sum by (cluster, nodegroup) (
        max by (cluster, instance, device) (
          node_filesystem_size_bytes{job="node-exporter",fstype!~"virtiofs|tmpfs|overlay|rootfs|squashfs|fuse.*"}
        )
        * on(instance) group_left(node)
        label_replace(kube_node_info{job="kube-state-metrics"}, "instance", "$1", "node", "(.*)")
        * on(node) group_left(nodegroup)
        label_replace(
          kube_node_labels{label_theriseunion_io_nodegroup!=""},
          "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
        )
      )
  - record: nodegroup:node_disk_reads:sum_rate
    expr: |-
      sum by (cluster, nodegroup) (
        irate(node_disk_reads_completed_total{job="node-exporter"}[5m])
        * on(instance) group_left(node)
        label_replace(kube_node_info{job="kube-state-metrics"}, "instance", "$1", "node", "(.*)")
        * on(node) group_left(nodegroup)
        label_replace(
          kube_node_labels{label_theriseunion_io_nodegroup!=""},
          "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
        )
      )
  - record: nodegroup:node_disk_writes:sum_rate
    expr: |-
      sum by (cluster, nodegroup) (
        irate(node_disk_writes_completed_total{job="node-exporter"}[5m])
        * on(instance) group_left(node)
        label_replace(kube_node_info{job="kube-state-metrics"}, "instance", "$1", "node", "(.*)")
        * on(node) group_left(nodegroup)
        label_replace(
          kube_node_labels{label_theriseunion_io_nodegroup!=""},
          "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
        )
      )
  - record: nodegroup:node_disk_read_bytes:sum_rate
    expr: |-
      sum by (cluster, nodegroup) (
        irate(node_disk_read_bytes_total{job="node-exporter"}[5m])
        * on(instance) group_left(node)
        label_replace(kube_node_info{job="kube-state-metrics"}, "instance", "$1", "node", "(.*)")
        * on(node) group_left(nodegroup)
        label_replace(
          kube_node_labels{label_theriseunion_io_nodegroup!=""},
          "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
        )
      )
  - record: nodegroup:node_disk_written_bytes:sum_rate
    expr: |-
      sum by (cluster, nodegroup) (
        irate(node_disk_written_bytes_total{job="node-exporter"}[5m])
        * on(instance) group_left(node)
        label_replace(kube_node_info{job="kube-state-metrics"}, "instance", "$1", "node", "(.*)")
        * on(node) group_left(nodegroup)
        label_replace(
          kube_node_labels{label_theriseunion_io_nodegroup!=""},
          "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
        )
      )
  - record: nodegroup:node_load1:sum
    expr: |-
      sum by (cluster, nodegroup) (
        node_load1{job="node-exporter"}
        * on(instance) group_left(node)
        label_replace(kube_node_info{job="kube-state-metrics"}, "instance", "$1", "node", "(.*)")
        * on(node) group_left(nodegroup)
        label_replace(
          kube_node_labels{label_theriseunion_io_nodegroup!=""},
          "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
        )
      )
  - record: nodegroup:node_load5:sum
    expr: |-
      sum by (cluster, nodegroup) (
        node_load5{job="node-exporter"}
        * on(instance) group_left(node)
        label_replace(kube_node_info{job="kube-state-metrics"}, "instance", "$1", "node", "(.*)")
        * on(node) group_left(nodegroup)
        label_replace(
          kube_node_labels{label_theriseunion_io_nodegroup!=""},
          "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
        )
      )
  - record: nodegroup:node_load15:sum
    expr: |-
      sum by (cluster, nodegroup) (
        node_load15{job="node-exporter"}
        * on(instance) group_left(node)
        label_replace(kube_node_info{job="kube-state-metrics"}, "instance", "$1", "node", "(.*)")
        * on(node) group_left(nodegroup)
        label_replace(
          kube_node_labels{label_theriseunion_io_nodegroup!=""},
          "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
        )
      )
  - record: nodegroup:cpu_utilization_percent
    expr: |-
      (
        nodegroup:node_cpu_usage:sum_rate
        /
        nodegroup:machine_cpu_cores:sum
      ) * 100
  - record: nodegroup:node_cpu_utilisation:avg
    expr: |-
      nodegroup:node_cpu_usage:sum_rate
      /
      nodegroup:machine_cpu_cores:sum
  - record: nodegroup:memory_utilization_percent
    expr: |-
      (
        nodegroup:node_memory_usage_bytes:sum
        /
        nodegroup:node_memory_total_bytes:sum
      ) * 100
  - record: nodegroup:node_memory_utilisation:avg
    expr: |-
      (nodegroup:node_memory_total_bytes:sum -
       nodegroup:node_memory_available_bytes:sum)
      /
      nodegroup:node_memory_total_bytes:sum
  - record: nodegroup:filesystem_utilization_percent
    expr: |-
      (
        nodegroup:node_filesystem_usage_bytes:sum
        /
        nodegroup:node_filesystem_total_bytes:sum
      ) * 100
- name: cluster-cpu-metrics
  interval: 30s
  rules:
  - record: cluster_cpu_total
    expr: |-
      sum(kube_node_status_allocatable{job="kube-state-metrics", resource="cpu"})
  - record: cluster_cpu_usage
    expr: |-
      sum(rate(node_cpu_seconds_total{job="node-exporter", mode!="idle"}[5m]))
  - record: cluster_cpu_utilisation
    expr: |-
      cluster_cpu_usage / cluster_cpu_total
  - record: cluster_cpu_master_total
    expr: |-
      sum(kube_node_status_allocatable{job="kube-state-metrics", resource="cpu", node=~".*master.*"})
  - record: cluster_cpu_master_usage
    expr: |-
      sum(
        rate(node_cpu_seconds_total{job="node-exporter", mode!="idle"}[5m])
        * on(instance) group_left(node)
        label_replace(kube_node_info{job="kube-state-metrics", node=~".*master.*"}, "instance", "$1", "node", "(.*)")
      )
  - record: cluster_cpu_master_utilisation
    expr: |-
      cluster_cpu_master_usage / cluster_cpu_master_total
  - record: cluster_cpu_non_master_total
    expr: |-
      sum(kube_node_status_allocatable{job="kube-state-metrics", resource="cpu", node!~".*master.*"})
  - record: cluster_cpu_non_master_usage
    expr: |-
      sum(
        rate(node_cpu_seconds_total{job="node-exporter", mode!="idle"}[5m])
        * on(instance) group_left(node)
        label_replace(kube_node_info{job="kube-state-metrics", node!~".*master.*"}, "instance", "$1", "node", "(.*)")
      )
  - record: cluster_cpu_non_master_utilisation
    expr: |-
      cluster_cpu_non_master_usage / cluster_cpu_non_master_total
  - record: cluster_pod_cpu_requests_total
    expr: |-
      sum(kube_pod_container_resource_requests{job="kube-state-metrics", resource="cpu"})
  - record: cluster_pod_cpu_limits_total
    expr: |-
      sum(kube_pod_container_resource_limits{job="kube-state-metrics", resource="cpu"})
- name: cluster-memory-metrics
  interval: 30s
  rules:
  - record: cluster_memory_total
    expr: |-
      sum(kube_node_status_allocatable{job="kube-state-metrics", resource="memory"})
  - record: cluster_memory_available
    expr: |-
      sum(node_memory_MemAvailable_bytes{job="node-exporter"})
  - record: cluster_memory_usage
    expr: |-
      sum(node_memory_MemTotal_bytes{job="node-exporter"} - node_memory_MemAvailable_bytes{job="node-exporter"})
  - record: cluster_memory_utilisation
    expr: |-
      cluster_memory_usage / cluster_memory_total
  - record: cluster_memory_master_total
    expr: |-
      sum(
        node_memory_MemTotal_bytes{job="node-exporter"}
        * on(instance) group_left(node)
        label_replace(kube_node_info{job="kube-state-metrics", node=~".*master.*"}, "instance", "$1", "node", "(.*)")
      )
  - record: cluster_memory_master_usage
    expr: |-
      sum(
        (node_memory_MemTotal_bytes{job="node-exporter"} - node_memory_MemAvailable_bytes{job="node-exporter"})
        * on(instance) group_left(node)
        label_replace(kube_node_info{job="kube-state-metrics", node=~".*master.*"}, "instance", "$1", "node", "(.*)")
      )
  - record: cluster_memory_master_utilisation
    expr: |-
      cluster_memory_master_usage / cluster_memory_master_total
  - record: cluster_memory_non_master_total
    expr: |-
      sum(
        node_memory_MemTotal_bytes{job="node-exporter"}
        * on(instance) group_left(node)
        label_replace(kube_node_info{job="kube-state-metrics", node!~".*master.*"}, "instance", "$1", "node", "(.*)")
      )
  - record: cluster_memory_non_master_usage
    expr: |-
      sum(
        (node_memory_MemTotal_bytes{job="node-exporter"} - node_memory_MemAvailable_bytes{job="node-exporter"})
        * on(instance) group_left(node)
        label_replace(kube_node_info{job="kube-state-metrics", node!~".*master.*"}, "instance", "$1", "node", "(.*)")
      )
  - record: cluster_memory_non_master_utilisation
    expr: |-
      cluster_memory_non_master_usage / cluster_memory_non_master_total
  - record: cluster_pod_memory_requests_total
    expr: |-
      sum(kube_pod_container_resource_requests{job="kube-state-metrics", resource="memory"})
  - record: cluster_pod_memory_limits_total
    expr: |-
      sum(kube_pod_container_resource_limits{job="kube-state-metrics", resource="memory"})
- name: cluster-disk-metrics
  interval: 30s
  rules:
  - record: cluster_disk_size_capacity
    expr: |-
      sum(node_filesystem_size_bytes{job="node-exporter", mountpoint="/", fstype!~"tmpfs|fuse.*"})
  - record: cluster_disk_size_available
    expr: |-
      sum(node_filesystem_avail_bytes{job="node-exporter", mountpoint="/", fstype!~"tmpfs|fuse.*"})
  - record: cluster_disk_size_usage
    expr: |-
      cluster_disk_size_capacity - cluster_disk_size_available
  - record: cluster_disk_inode_total
    expr: |-
      sum(node_filesystem_files{job="node-exporter", mountpoint="/", fstype!~"tmpfs|fuse.*"})
  - record: cluster_disk_inode_usage
    expr: |-
      sum(
        node_filesystem_files{job="node-exporter", mountpoint="/", fstype!~"tmpfs|fuse.*"}
        -
        node_filesystem_files_free{job="node-exporter", mountpoint="/", fstype!~"tmpfs|fuse.*"}
      )
- name: cluster-node-metrics
  interval: 30s
  rules:
  - record: cluster_node_total
    expr: |-
      count(kube_node_info{job="kube-state-metrics"})
  - record: cluster_node_master_count
    expr: |-
      count(kube_node_info{job="kube-state-metrics", node=~".*master.*"})
  - record: cluster_node_online
    expr: |-
      count(kube_node_status_condition{job="kube-state-metrics", condition="Ready", status="true"})
  - record: cluster_node_offline
    expr: |-
      cluster_node_total - cluster_node_online
- name: cluster-pod-metrics
  interval: 30s
  rules:
  - record: cluster_pod_quota
    expr: |-
      sum(kube_node_status_allocatable{job="kube-state-metrics", resource="pods"})
  - record: cluster_pod_running_count
    expr: |-
      count(kube_pod_status_phase{job="kube-state-metrics", phase="Running"})
  - record: cluster_pod_count
    expr: |-
      count(kube_pod_info{job="kube-state-metrics"})
- name: cluster-network-metrics
  interval: 30s
  rules:
  - record: cluster_net_bytes_received
    expr: |-
      sum(rate(node_network_receive_bytes_total{job="node-exporter", device!~"lo|veth.*|docker.*|br.*"}[5m]))
  - record: cluster_net_bytes_transmitted
    expr: |-
      sum(rate(node_network_transmit_bytes_total{job="node-exporter", device!~"lo|veth.*|docker.*|br.*"}[5m]))
- name: workspace-aggregation-rules
  interval: 30s
  rules:
  - record: workspace:container_cpu_usage_seconds:sum_rate
    expr: |-
      sum by (cluster, workspace) (
        irate(container_cpu_usage_seconds_total{job="kubelet", container!="POD", container!="", image!=""}[5m])
        * on(namespace) group_left(workspace)
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
  - record: workspace:container_memory_usage_bytes:sum
    expr: |-
      sum by (cluster, workspace) (
        container_memory_usage_bytes{job="kubelet", container!="POD", container!="", image!=""}
        * on(namespace) group_left(workspace)
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
  - record: workspace:container_memory_rss:sum
    expr: |-
      sum by (cluster, workspace) (
        container_memory_rss{job="kubelet", container!="POD", container!="", image!=""}
        * on(namespace) group_left(workspace)
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
  - record: workspace:kube_pod_info:count
    expr: |-
      count by (cluster, workspace) (
        kube_pod_info{job="kube-state-metrics"}
        * on(namespace) group_left(workspace)
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
  - record: workspace:kube_namespace:count
    expr: |-
      count by (cluster, workspace) (
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
  - record: workspace:container_network_receive_bytes:sum_rate
    expr: |-
      sum by (cluster, workspace) (
        irate(container_network_receive_bytes_total{job="kubelet", interface!="lo"}[5m])
        * on(namespace) group_left(workspace)
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
  - record: workspace:container_network_transmit_bytes:sum_rate
    expr: |-
      sum by (cluster, workspace) (
        irate(container_network_transmit_bytes_total{job="kubelet", interface!="lo"}[5m])
        * on(namespace) group_left(workspace)
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
  - record: workspace:container_network_receive_packets:sum_rate
    expr: |-
      sum by (cluster, workspace) (
        irate(container_network_receive_packets_total{job="kubelet", interface!="lo"}[5m])
        * on(namespace) group_left(workspace)
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
  - record: workspace:container_network_transmit_packets:sum_rate
    expr: |-
      sum by (cluster, workspace) (
        irate(container_network_transmit_packets_total{job="kubelet", interface!="lo"}[5m])
        * on(namespace) group_left(workspace)
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
  - record: workspace:container_fs_reads:sum_rate
    expr: |-
      sum by (cluster, workspace) (
        irate(container_fs_reads_total{job="kubelet"}[5m])
        * on(namespace) group_left(workspace)
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
  - record: workspace:container_fs_writes:sum_rate
    expr: |-
      sum by (cluster, workspace) (
        irate(container_fs_writes_total{job="kubelet"}[5m])
        * on(namespace) group_left(workspace)
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
  - record: workspace:container_fs_reads_bytes:sum_rate
    expr: |-
      sum by (cluster, workspace) (
        irate(container_fs_reads_bytes_total{job="kubelet"}[5m])
        * on(namespace) group_left(workspace)
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
  - record: workspace:container_fs_writes_bytes:sum_rate
    expr: |-
      sum by (cluster, workspace) (
        irate(container_fs_writes_bytes_total{job="kubelet"}[5m])
        * on(namespace) group_left(workspace)
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
  - record: workspace:kube_pod_container_resource_requests_memory:sum
    expr: |-
      sum by (cluster, workspace) (
        kube_pod_container_resource_requests{job="kube-state-metrics", resource="memory"}
        * on(namespace) group_left(workspace)
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
  - record: workspace:kube_pod_container_resource_limits_memory:sum
    expr: |-
      sum by (cluster, workspace) (
        kube_pod_container_resource_limits{job="kube-state-metrics", resource="memory"}
        * on(namespace) group_left(workspace)
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
  - record: workspace:kube_pod_container_resource_requests_cpu:sum
    expr: |-
      sum by (cluster, workspace) (
        kube_pod_container_resource_requests{job="kube-state-metrics", resource="cpu"}
        * on(namespace) group_left(workspace)
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
  - record: workspace:kube_pod_container_resource_limits_cpu:sum
    expr: |-
      sum by (cluster, workspace) (
        kube_pod_container_resource_limits{job="kube-state-metrics", resource="cpu"}
        * on(namespace) group_left(workspace)
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
  - record: workspace:kube_deployment:count
    expr: |-
      count by (cluster, workspace) (
        kube_deployment_spec_replicas{job="kube-state-metrics"}
        * on(namespace) group_left(workspace)
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
  - record: workspace:kube_statefulset:count
    expr: |-
      count by (cluster, workspace) (
        kube_statefulset_replicas{job="kube-state-metrics"}
        * on(namespace) group_left(workspace)
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
  - record: workspace:kube_daemonset:count
    expr: |-
      count by (cluster, workspace) (
        kube_daemonset_status_desired_number_scheduled{job="kube-state-metrics"}
        * on(namespace) group_left(workspace)
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
  - record: workspace:kube_job:count
    expr: |-
      count by (cluster, workspace) (
        kube_job_info{job="kube-state-metrics"}
        * on(namespace) group_left(workspace)
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
  - record: workspace:kube_cronjob:count
    expr: |-
      count by (cluster, workspace) (
        kube_cronjob_info{job="kube-state-metrics"}
        * on(namespace) group_left(workspace)
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
  - record: workspace:kube_service:count
    expr: |-
      count by (cluster, workspace) (
        kube_service_info{job="kube-state-metrics"}
        * on(namespace) group_left(workspace)
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
  - record: workspace:kube_ingress:count
    expr: |-
      count by (cluster, workspace) (
        kube_ingress_info{job="kube-state-metrics"}
        * on(namespace) group_left(workspace)
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
  - record: workspace:memory_utilization_percent
    expr: |-
      (
        workspace:container_memory_usage_bytes:sum
        /
        workspace:kube_pod_container_resource_requests_memory:sum
      ) * 100
  - record: workspace:cpu_utilization_percent
    expr: |-
      (
        workspace:container_cpu_usage_seconds:sum_rate
        /
        workspace:kube_pod_container_resource_requests_cpu:sum
      ) * 100
  - record: workspace:kube_persistentvolumeclaim:count
    expr: |-
      count by (cluster, workspace) (
        kube_persistentvolumeclaim_info{job="kube-state-metrics"}
        * on(namespace) group_left(workspace)
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
  - record: workspace:kube_persistentvolumeclaim_bound:count
    expr: |-
      count by (cluster, workspace) (
        kube_persistentvolumeclaim_status_phase{job="kube-state-metrics", phase="Bound"}
        * on(namespace, persistentvolumeclaim) group_left()
        kube_persistentvolumeclaim_info{job="kube-state-metrics"}
        * on(namespace) group_left(workspace)
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
  - record: workspace:kube_persistentvolumeclaim_pending:count
    expr: |-
      count by (cluster, workspace) (
        kube_persistentvolumeclaim_status_phase{job="kube-state-metrics", phase="Pending"}
        * on(namespace, persistentvolumeclaim) group_left()
        kube_persistentvolumeclaim_info{job="kube-state-metrics"}
        * on(namespace) group_left(workspace)
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
  - record: workspace:kube_persistentvolumeclaim_capacity_bytes:sum
    expr: |-
      sum by (cluster, workspace) (
        kube_persistentvolumeclaim_resource_requests_storage_bytes{job="kube-state-metrics"}
        * on(namespace) group_left(workspace)
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
  - record: workspace:kube_persistentvolumeclaim_bound_capacity_bytes:sum
    expr: |-
      sum by (cluster, workspace) (
        kube_persistentvolumeclaim_resource_requests_storage_bytes{job="kube-state-metrics"}
        * on(namespace, persistentvolumeclaim) group_left()
        kube_persistentvolumeclaim_status_phase{job="kube-state-metrics", phase="Bound"}
        * on(namespace) group_left(workspace)
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
  - record: workspace:kube_persistentvolume:count
    expr: |-
      count by (cluster, workspace) (
        kube_persistentvolume_claim_ref{job="kube-state-metrics"}
        * on(namespace) group_left(workspace)
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
  - record: workspace:kube_storageclass:count
    expr: |-
      count by (cluster, workspace) (
        group by (cluster, workspace, storageclass) (
          kube_persistentvolumeclaim_info{job="kube-state-metrics"}
          * on(namespace) group_left(workspace)
          label_replace(
            kube_namespace_labels{label_theriseunion_io_workspace!=""},
            "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
          )
        )
      )
  - record: workspace:kube_persistentvolumeclaim_bytes_used:sum
    expr: |-
      sum by (cluster, workspace) (
        kubelet_volume_stats_used_bytes
        * on(namespace) group_left(workspace)
        label_replace(
          kube_namespace_labels{label_theriseunion_io_workspace!=""},
          "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
        )
      )
- name: namespace-aggregation-rules
  interval: 30s
  rules:
  - record: namespace:kube_pod:count
    expr: |-
      count by (cluster, namespace) (
        kube_pod_info
      )
  - record: namespace:kube_deployment:count
    expr: |-
      count by (cluster, namespace) (
        kube_deployment_spec_replicas
      )
  - record: namespace:kube_statefulset:count
    expr: |-
      count by (cluster, namespace) (
        kube_statefulset_replicas
      )
  - record: namespace:kube_daemonset:count
    expr: |-
      count by (cluster, namespace) (
        kube_daemonset_status_desired_number_scheduled
      )
  - record: namespace:kube_job:count
    expr: |-
      count by (cluster, namespace) (
        kube_job_info
      )
  - record: namespace:kube_cronjob:count
    expr: |-
      count by (cluster, namespace) (
        kube_cronjob_info
      )
  - record: namespace:kube_service:count
    expr: |-
      count by (cluster, namespace) (
        kube_service_info
      )
  - record: namespace:container_cpu_usage_seconds:sum_rate
    expr: |-
      sum by (cluster, namespace) (
        irate(container_cpu_usage_seconds_total{container!="POD", container!="", image!=""}[5m])
      )
  - record: namespace:container_memory_usage_bytes:sum
    expr: |-
      sum by (cluster, namespace) (
        container_memory_usage_bytes{container!="POD", container!="", image!=""}
      )
  - record: namespace:container_network_receive_packets:sum_rate
    expr: |-
      sum by (cluster, namespace) (
        irate(container_network_receive_packets_total{interface!="lo"}[5m])
      )
  - record: namespace:container_network_transmit_packets:sum_rate
    expr: |-
      sum by (cluster, namespace) (
        irate(container_network_transmit_packets_total{interface!="lo"}[5m])
      )
- name: node-npu-metrics
  interval: 30s
  rules:
  - record: edge_node_npu_memory_total
    expr: |-
      sum by (cluster, instance) (
        npu_chip_info_memory_total
      )
  - record: edge_node_npu_memory_usage
    expr: |-
      sum by (cluster, instance) (
        npu_chip_info_memory_usage
      )
  - record: edge_node_npu_count
    expr: |-
      count by (cluster, instance) (
        npu_chip_info_memory_total
      )
  - record: edge_node_npu_utilisation_avg
    expr: |-
      avg by (cluster, instance) (
        npu_chip_info_utilization
      )
  - record: edge_node_npu_temperature_avg
    expr: |-
      avg by (cluster, instance) (
        npu_chip_info_temperature
      )
  - record: edge_node_npu_power_total
    expr: |-
      sum by (cluster, instance) (
        npu_chip_info_power
      )
- name: cluster-npu-metrics
  interval: 30s
  rules:
  - record: edge_cluster_npu_memory_total
    expr: |-
      sum(edge_node_npu_memory_total)
  - record: edge_cluster_npu_memory_usage
    expr: |-
      sum(edge_node_npu_memory_usage)
  - record: edge_cluster_npu_count
    expr: |-
      sum(edge_node_npu_count)
  - record: edge_cluster_npu_utilisation_avg
    expr: |-
      avg(edge_node_npu_utilisation_avg)
  - record: edge_cluster_npu_power_total
    expr: |-
      sum(edge_node_npu_power_total)
