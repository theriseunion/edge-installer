groups:
- name: node-cpu-metrics
  interval: 30s
  rules:
  - record: node_cpu_total
    expr: "count by (cluster, instance) (\n  node_cpu_seconds_total{job=\"node-exporter\"\
      , mode=\"idle\"}\n)\n"
  - record: node_cpu_usage
    expr: "sum by (cluster, instance) (\n  rate(node_cpu_seconds_total{job=\"node-exporter\"\
      , mode!=\"idle\"}[5m])\n)\n"
  - record: node_cpu_utilisation
    expr: 'node_cpu_usage / node_cpu_total

      '
  - record: node_cpu_allocatable_total
    expr: 'kube_node_status_allocatable{job="kube-state-metrics", resource="cpu"}

      '
- name: node-memory-metrics
  interval: 30s
  rules:
  - record: node_memory_total
    expr: 'node_memory_MemTotal_bytes{job="node-exporter"}

      '
  - record: node_memory_available
    expr: 'node_memory_MemAvailable_bytes{job="node-exporter"}

      '
  - record: node_memory_usage
    expr: 'node_memory_MemTotal_bytes{job="node-exporter"}

      -

      node_memory_MemAvailable_bytes{job="node-exporter"}

      '
  - record: node_memory_utilisation
    expr: 'node_memory_usage / node_memory_total

      '
  - record: node_memory_allocatable_total
    expr: 'kube_node_status_allocatable{job="kube-state-metrics", resource="memory"}

      '
- name: node-disk-metrics
  interval: 30s
  rules:
  - record: node_disk_size_capacity
    expr: "sum by (cluster, instance) (\n  node_filesystem_size_bytes{job=\"node-exporter\"\
      , mountpoint=\"/\", fstype!~\"tmpfs|fuse.*\"}\n)\n"
  - record: node_disk_size_available
    expr: "sum by (cluster, instance) (\n  node_filesystem_avail_bytes{job=\"node-exporter\"\
      , mountpoint=\"/\", fstype!~\"tmpfs|fuse.*\"}\n)\n"
  - record: node_disk_size_usage
    expr: 'node_disk_size_capacity - node_disk_size_available

      '
  - record: node_disk_inode_total
    expr: "sum by (cluster, instance) (\n  node_filesystem_files{job=\"node-exporter\"\
      , mountpoint=\"/\", fstype!~\"tmpfs|fuse.*\"}\n)\n"
  - record: node_disk_inode_usage
    expr: "sum by (cluster, instance) (\n  node_filesystem_files{job=\"node-exporter\"\
      , mountpoint=\"/\", fstype!~\"tmpfs|fuse.*\"}\n  -\n  node_filesystem_files_free{job=\"\
      node-exporter\", mountpoint=\"/\", fstype!~\"tmpfs|fuse.*\"}\n)\n"
  - record: node_ephemeral_storage_allocatable_total
    expr: 'kube_node_status_allocatable{job="kube-state-metrics", resource="ephemeral-storage"}

      '
- name: node-pod-metrics
  interval: 30s
  rules:
  - record: node_pod_count
    expr: "count by (cluster, node) (\n  kube_pod_info{job=\"kube-state-metrics\"\
      }\n)\n"
  - record: node_pod_quota
    expr: 'kube_node_status_allocatable{job="kube-state-metrics", resource="pods"}

      '
  - record: node_pod_requests_cpu_total
    expr: "sum by (cluster, node) (\n  kube_pod_container_resource_requests{job=\"\
      kube-state-metrics\", resource=\"cpu\"}\n  * on(cluster, namespace, pod) group_left(node)\n\
      \  kube_pod_info{job=\"kube-state-metrics\"}\n)\n"
  - record: node_pod_limits_cpu_total
    expr: "sum by (cluster, node) (\n  kube_pod_container_resource_limits{job=\"kube-state-metrics\"\
      , resource=\"cpu\"}\n  * on(cluster, namespace, pod) group_left(node)\n  kube_pod_info{job=\"\
      kube-state-metrics\"}\n)\n"
  - record: node_pod_requests_memory_total
    expr: "sum by (cluster, node) (\n  kube_pod_container_resource_requests{job=\"\
      kube-state-metrics\", resource=\"memory\"}\n  * on(cluster, namespace, pod)\
      \ group_left(node)\n  kube_pod_info{job=\"kube-state-metrics\"}\n)\n"
  - record: node_pod_limits_memory_total
    expr: "sum by (cluster, node) (\n  kube_pod_container_resource_limits{job=\"kube-state-metrics\"\
      , resource=\"memory\"}\n  * on(cluster, namespace, pod) group_left(node)\n \
      \ kube_pod_info{job=\"kube-state-metrics\"}\n)\n"
  - record: node_pod_requests_ephemeral_storage_total
    expr: "sum by (cluster, node) (\n  kube_pod_container_resource_requests{job=\"\
      kube-state-metrics\", resource=\"ephemeral-storage\"}\n  * on(cluster, namespace,\
      \ pod) group_left(node)\n  kube_pod_info{job=\"kube-state-metrics\"}\n)\n"
- name: container-gpu-metrics
  interval: 30s
  rules:
  - record: container_gpu_usage
    expr: "DCGM_FI_DEV_GPU_UTIL\n* on(uuid) group_left(pod, namespace, container)\n\
      label_replace(\n  label_replace(\n    label_replace(\n      kube_pod_container_info{container!=\"\
      POD\"},\n      \"uuid\", \"$1\", \"pod\", \".*-([a-f0-9\\\\-]+)$\"\n    ),\n\
      \    \"pod\", \"$1\", \"pod\", \"(.*)\"\n  ),\n  \"namespace\", \"$1\", \"namespace\"\
      , \"(.*)\"\n)\n"
  - record: container_gpu_memory_usage
    expr: "DCGM_FI_DEV_FB_USED * 1024 * 1024\n* on(uuid) group_left(pod, namespace,\
      \ container)\nlabel_replace(\n  label_replace(\n    label_replace(\n      kube_pod_container_info{container!=\"\
      POD\"},\n      \"uuid\", \"$1\", \"pod\", \".*-([a-f0-9\\\\-]+)$\"\n    ),\n\
      \    \"pod\", \"$1\", \"pod\", \"(.*)\"\n  ),\n  \"namespace\", \"$1\", \"namespace\"\
      , \"(.*)\"\n)\n"
- name: node-gpu-metrics
  interval: 30s
  rules:
  - record: node_gpu_memory_total
    expr: "sum by (cluster, instance) (\n  DCGM_FI_DEV_FB_TOTAL * 1024 * 1024\n)\n"
  - record: node_gpu_memory_usage
    expr: "sum by (cluster, instance) (\n  DCGM_FI_DEV_FB_USED * 1024 * 1024\n)\n"
  - record: node_gpu_count
    expr: "count by (cluster, instance) (\n  DCGM_FI_DEV_FB_TOTAL\n)\n"
  - record: node_gpu_utilisation_avg
    expr: "avg by (cluster, instance) (\n  DCGM_FI_DEV_GPU_UTIL\n)\n"
  - record: node_gpu_temperature_avg
    expr: "avg by (cluster, instance) (\n  DCGM_FI_DEV_GPU_TEMP\n)\n"
  - record: node_gpu_power_total
    expr: "sum by (cluster, instance) (\n  DCGM_FI_DEV_POWER_USAGE\n)\n"
- name: nodegroup-aggregation-rules
  interval: 30s
  rules:
  - record: nodegroup:kube_node_info:count
    expr: "count by (cluster, nodegroup) (\n  kube_node_info{job=\"kube-state-metrics\"\
      }\n  * on(node) group_left(nodegroup)\n  label_replace(\n    kube_node_labels{label_theriseunion_io_nodegroup!=\"\
      \"},\n    \"nodegroup\", \"$1\", \"label_theriseunion_io_nodegroup\", \"(.*)\"\
      \n  )\n)\n"
  - record: nodegroup:node_cpu_usage:sum_rate
    expr: "sum by (cluster, nodegroup) (\n  (1 - avg by (cluster, instance) (irate(node_cpu_seconds_total{job=\"\
      node-exporter\",mode=\"idle\"}[5m])))\n  * on(instance) group_left(node)\n \
      \ label_replace(kube_node_info{job=\"kube-state-metrics\"}, \"instance\", \"\
      $1\", \"node\", \"(.*)\")\n  * on(node) group_left(nodegroup)\n  label_replace(\n\
      \    kube_node_labels{label_theriseunion_io_nodegroup!=\"\"},\n    \"nodegroup\"\
      , \"$1\", \"label_theriseunion_io_nodegroup\", \"(.*)\"\n  )\n)\n"
  - record: nodegroup:machine_cpu_cores:sum
    expr: "sum by (cluster, nodegroup) (\n  machine_cpu_cores\n  * on(instance) group_left(node)\n\
      \  label_replace(kube_node_info{job=\"kube-state-metrics\"}, \"instance\", \"\
      $1\", \"node\", \"(.*)\")\n  * on(node) group_left(nodegroup)\n  label_replace(\n\
      \    kube_node_labels{label_theriseunion_io_nodegroup!=\"\"},\n    \"nodegroup\"\
      , \"$1\", \"label_theriseunion_io_nodegroup\", \"(.*)\"\n  )\n)\n"
  - record: nodegroup:node_memory_usage_bytes:sum
    expr: "sum by (cluster, nodegroup) (\n  (node_memory_MemTotal_bytes{job=\"node-exporter\"\
      } - node_memory_MemAvailable_bytes{job=\"node-exporter\"})\n  * on(instance)\
      \ group_left(node)\n  label_replace(kube_node_info{job=\"kube-state-metrics\"\
      }, \"instance\", \"$1\", \"node\", \"(.*)\")\n  * on(node) group_left(nodegroup)\n\
      \  label_replace(\n    kube_node_labels{label_theriseunion_io_nodegroup!=\"\"\
      },\n    \"nodegroup\", \"$1\", \"label_theriseunion_io_nodegroup\", \"(.*)\"\
      \n  )\n)\n"
  - record: nodegroup:node_memory_available_bytes:sum
    expr: "sum by (cluster, nodegroup) (\n  node_memory_MemAvailable_bytes{job=\"\
      node-exporter\"}\n  * on(instance) group_left(node)\n  label_replace(kube_node_info{job=\"\
      kube-state-metrics\"}, \"instance\", \"$1\", \"node\", \"(.*)\")\n  * on(node)\
      \ group_left(nodegroup)\n  label_replace(\n    kube_node_labels{label_theriseunion_io_nodegroup!=\"\
      \"},\n    \"nodegroup\", \"$1\", \"label_theriseunion_io_nodegroup\", \"(.*)\"\
      \n  )\n)\n"
  - record: nodegroup:node_memory_total_bytes:sum
    expr: "sum by (cluster, nodegroup) (\n  node_memory_MemTotal_bytes{job=\"node-exporter\"\
      }\n  * on(instance) group_left(node)\n  label_replace(kube_node_info{job=\"\
      kube-state-metrics\"}, \"instance\", \"$1\", \"node\", \"(.*)\")\n  * on(node)\
      \ group_left(nodegroup)\n  label_replace(\n    kube_node_labels{label_theriseunion_io_nodegroup!=\"\
      \"},\n    \"nodegroup\", \"$1\", \"label_theriseunion_io_nodegroup\", \"(.*)\"\
      \n  )\n)\n"
  - record: nodegroup:node_network_receive_bytes:sum_rate
    expr: "sum by (cluster, nodegroup) (\n  irate(node_network_receive_bytes_total{job=\"\
      node-exporter\",device!~\"lo|veth.*|docker.*|br.*\"}[5m])\n  * on(instance)\
      \ group_left(node)\n  label_replace(kube_node_info{job=\"kube-state-metrics\"\
      }, \"instance\", \"$1\", \"node\", \"(.*)\")\n  * on(node) group_left(nodegroup)\n\
      \  label_replace(\n    kube_node_labels{label_theriseunion_io_nodegroup!=\"\"\
      },\n    \"nodegroup\", \"$1\", \"label_theriseunion_io_nodegroup\", \"(.*)\"\
      \n  )\n)\n"
  - record: nodegroup:node_network_transmit_bytes:sum_rate
    expr: "sum by (cluster, nodegroup) (\n  irate(node_network_transmit_bytes_total{job=\"\
      node-exporter\",device!~\"lo|veth.*|docker.*|br.*\"}[5m])\n  * on(instance)\
      \ group_left(node)\n  label_replace(kube_node_info{job=\"kube-state-metrics\"\
      }, \"instance\", \"$1\", \"node\", \"(.*)\")\n  * on(node) group_left(nodegroup)\n\
      \  label_replace(\n    kube_node_labels{label_theriseunion_io_nodegroup!=\"\"\
      },\n    \"nodegroup\", \"$1\", \"label_theriseunion_io_nodegroup\", \"(.*)\"\
      \n  )\n)\n"
  - record: nodegroup:node_network_receive_packets:sum_rate
    expr: "sum by (cluster, nodegroup) (\n  irate(node_network_receive_packets_total{job=\"\
      node-exporter\",device!~\"lo|veth.*|docker.*|br.*\"}[5m])\n  * on(instance)\
      \ group_left(node)\n  label_replace(kube_node_info{job=\"kube-state-metrics\"\
      }, \"instance\", \"$1\", \"node\", \"(.*)\")\n  * on(node) group_left(nodegroup)\n\
      \  label_replace(\n    kube_node_labels{label_theriseunion_io_nodegroup!=\"\"\
      },\n    \"nodegroup\", \"$1\", \"label_theriseunion_io_nodegroup\", \"(.*)\"\
      \n  )\n)\n"
  - record: nodegroup:node_network_transmit_packets:sum_rate
    expr: "sum by (cluster, nodegroup) (\n  irate(node_network_transmit_packets_total{job=\"\
      node-exporter\",device!~\"lo|veth.*|docker.*|br.*\"}[5m])\n  * on(instance)\
      \ group_left(node)\n  label_replace(kube_node_info{job=\"kube-state-metrics\"\
      }, \"instance\", \"$1\", \"node\", \"(.*)\")\n  * on(node) group_left(nodegroup)\n\
      \  label_replace(\n    kube_node_labels{label_theriseunion_io_nodegroup!=\"\"\
      },\n    \"nodegroup\", \"$1\", \"label_theriseunion_io_nodegroup\", \"(.*)\"\
      \n  )\n)\n"
  # Disk usage: filter out virtual filesystems (virtiofs, tmpfs, overlay) and deduplicate by device
  - record: nodegroup:node_filesystem_usage_bytes:sum
    expr: |
      sum by (cluster, nodegroup) (
        max by (cluster, instance, device) (
          (node_filesystem_size_bytes{job="node-exporter",fstype!~"virtiofs|tmpfs|overlay|rootfs|squashfs|fuse.*"}
           - node_filesystem_avail_bytes{job="node-exporter",fstype!~"virtiofs|tmpfs|overlay|rootfs|squashfs|fuse.*"})
        )
        * on(instance) group_left(node)
        label_replace(kube_node_info{job="kube-state-metrics"}, "instance", "$1", "node", "(.*)")
        * on(node) group_left(nodegroup)
        label_replace(
          kube_node_labels{label_theriseunion_io_nodegroup!=""},
          "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
        )
      )
  # Disk available: filter out virtual filesystems and deduplicate by device
  - record: nodegroup:node_filesystem_available_bytes:sum
    expr: |
      sum by (cluster, nodegroup) (
        max by (cluster, instance, device) (
          node_filesystem_avail_bytes{job="node-exporter",fstype!~"virtiofs|tmpfs|overlay|rootfs|squashfs|fuse.*"}
        )
        * on(instance) group_left(node)
        label_replace(kube_node_info{job="kube-state-metrics"}, "instance", "$1", "node", "(.*)")
        * on(node) group_left(nodegroup)
        label_replace(
          kube_node_labels{label_theriseunion_io_nodegroup!=""},
          "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
        )
      )
  # Disk total: filter out virtual filesystems and deduplicate by device
  - record: nodegroup:node_filesystem_total_bytes:sum
    expr: |
      sum by (cluster, nodegroup) (
        max by (cluster, instance, device) (
          node_filesystem_size_bytes{job="node-exporter",fstype!~"virtiofs|tmpfs|overlay|rootfs|squashfs|fuse.*"}
        )
        * on(instance) group_left(node)
        label_replace(kube_node_info{job="kube-state-metrics"}, "instance", "$1", "node", "(.*)")
        * on(node) group_left(nodegroup)
        label_replace(
          kube_node_labels{label_theriseunion_io_nodegroup!=""},
          "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
        )
      )
  - record: nodegroup:node_disk_reads:sum_rate
    expr: "sum by (cluster, nodegroup) (\n  irate(node_disk_reads_completed_total{job=\"\
      node-exporter\"}[5m])\n  * on(instance) group_left(node)\n  label_replace(kube_node_info{job=\"\
      kube-state-metrics\"}, \"instance\", \"$1\", \"node\", \"(.*)\")\n  * on(node)\
      \ group_left(nodegroup)\n  label_replace(\n    kube_node_labels{label_theriseunion_io_nodegroup!=\"\
      \"},\n    \"nodegroup\", \"$1\", \"label_theriseunion_io_nodegroup\", \"(.*)\"\
      \n  )\n)\n"
  - record: nodegroup:node_disk_writes:sum_rate
    expr: "sum by (cluster, nodegroup) (\n  irate(node_disk_writes_completed_total{job=\"\
      node-exporter\"}[5m])\n  * on(instance) group_left(node)\n  label_replace(kube_node_info{job=\"\
      kube-state-metrics\"}, \"instance\", \"$1\", \"node\", \"(.*)\")\n  * on(node)\
      \ group_left(nodegroup)\n  label_replace(\n    kube_node_labels{label_theriseunion_io_nodegroup!=\"\
      \"},\n    \"nodegroup\", \"$1\", \"label_theriseunion_io_nodegroup\", \"(.*)\"\
      \n  )\n)\n"
  - record: nodegroup:node_disk_read_bytes:sum_rate
    expr: "sum by (cluster, nodegroup) (\n  irate(node_disk_read_bytes_total{job=\"\
      node-exporter\"}[5m])\n  * on(instance) group_left(node)\n  label_replace(kube_node_info{job=\"\
      kube-state-metrics\"}, \"instance\", \"$1\", \"node\", \"(.*)\")\n  * on(node)\
      \ group_left(nodegroup)\n  label_replace(\n    kube_node_labels{label_theriseunion_io_nodegroup!=\"\
      \"},\n    \"nodegroup\", \"$1\", \"label_theriseunion_io_nodegroup\", \"(.*)\"\
      \n  )\n)\n"
  - record: nodegroup:node_disk_written_bytes:sum_rate
    expr: "sum by (cluster, nodegroup) (\n  irate(node_disk_written_bytes_total{job=\"\
      node-exporter\"}[5m])\n  * on(instance) group_left(node)\n  label_replace(kube_node_info{job=\"\
      kube-state-metrics\"}, \"instance\", \"$1\", \"node\", \"(.*)\")\n  * on(node)\
      \ group_left(nodegroup)\n  label_replace(\n    kube_node_labels{label_theriseunion_io_nodegroup!=\"\
      \"},\n    \"nodegroup\", \"$1\", \"label_theriseunion_io_nodegroup\", \"(.*)\"\
      \n  )\n)\n"
  - record: nodegroup:node_load1:sum
    expr: "sum by (cluster, nodegroup) (\n  node_load1{job=\"node-exporter\"}\n  *\
      \ on(instance) group_left(node)\n  label_replace(kube_node_info{job=\"kube-state-metrics\"\
      }, \"instance\", \"$1\", \"node\", \"(.*)\")\n  * on(node) group_left(nodegroup)\n\
      \  label_replace(\n    kube_node_labels{label_theriseunion_io_nodegroup!=\"\"\
      },\n    \"nodegroup\", \"$1\", \"label_theriseunion_io_nodegroup\", \"(.*)\"\
      \n  )\n)\n"
  - record: nodegroup:node_load5:sum
    expr: "sum by (cluster, nodegroup) (\n  node_load5{job=\"node-exporter\"}\n  *\
      \ on(instance) group_left(node)\n  label_replace(kube_node_info{job=\"kube-state-metrics\"\
      }, \"instance\", \"$1\", \"node\", \"(.*)\")\n  * on(node) group_left(nodegroup)\n\
      \  label_replace(\n    kube_node_labels{label_theriseunion_io_nodegroup!=\"\"\
      },\n    \"nodegroup\", \"$1\", \"label_theriseunion_io_nodegroup\", \"(.*)\"\
      \n  )\n)\n"
  - record: nodegroup:node_load15:sum
    expr: "sum by (cluster, nodegroup) (\n  node_load15{job=\"node-exporter\"}\n \
      \ * on(instance) group_left(node)\n  label_replace(kube_node_info{job=\"kube-state-metrics\"\
      }, \"instance\", \"$1\", \"node\", \"(.*)\")\n  * on(node) group_left(nodegroup)\n\
      \  label_replace(\n    kube_node_labels{label_theriseunion_io_nodegroup!=\"\"\
      },\n    \"nodegroup\", \"$1\", \"label_theriseunion_io_nodegroup\", \"(.*)\"\
      \n  )\n)\n"
  - record: nodegroup:cpu_utilization_percent
    expr: "(\n  nodegroup:node_cpu_usage:sum_rate\n  /\n  nodegroup:machine_cpu_cores:sum\n\
      ) * 100\n"
  - record: nodegroup:node_cpu_utilisation:avg
    expr: 'nodegroup:node_cpu_usage:sum_rate

      /

      nodegroup:machine_cpu_cores:sum

      '
  - record: nodegroup:memory_utilization_percent
    expr: "(\n  nodegroup:node_memory_usage_bytes:sum\n  /\n  nodegroup:node_memory_total_bytes:sum\n\
      ) * 100\n"
  - record: nodegroup:node_memory_utilisation:avg
    expr: "(nodegroup:node_memory_total_bytes:sum -\n nodegroup:node_memory_available_bytes:sum)\n\
      /\nnodegroup:node_memory_total_bytes:sum\n"
  - record: nodegroup:filesystem_utilization_percent
    expr: "(\n  nodegroup:node_filesystem_usage_bytes:sum\n  /\n  nodegroup:node_filesystem_total_bytes:sum\n\
      ) * 100\n"
- name: cluster-cpu-metrics
  interval: 30s
  rules:
  - record: cluster_cpu_total
    expr: 'sum(kube_node_status_allocatable{job="kube-state-metrics", resource="cpu"})

      '
  - record: cluster_cpu_usage
    expr: 'sum(rate(node_cpu_seconds_total{job="node-exporter", mode!="idle"}[5m]))

      '
  - record: cluster_cpu_utilisation
    expr: 'cluster_cpu_usage / cluster_cpu_total

      '
  - record: cluster_cpu_master_total
    expr: 'sum(kube_node_status_allocatable{job="kube-state-metrics", resource="cpu",
      node=~".*master.*"})

      '
  - record: cluster_cpu_master_usage
    expr: "sum(\n  rate(node_cpu_seconds_total{job=\"node-exporter\", mode!=\"idle\"\
      }[5m])\n  * on(instance) group_left(node)\n  label_replace(kube_node_info{job=\"\
      kube-state-metrics\", node=~\".*master.*\"}, \"instance\", \"$1\", \"node\"\
      , \"(.*)\")\n)\n"
  - record: cluster_cpu_master_utilisation
    expr: 'cluster_cpu_master_usage / cluster_cpu_master_total

      '
  - record: cluster_cpu_non_master_total
    expr: 'sum(kube_node_status_allocatable{job="kube-state-metrics", resource="cpu",
      node!~".*master.*"})

      '
  - record: cluster_cpu_non_master_usage
    expr: "sum(\n  rate(node_cpu_seconds_total{job=\"node-exporter\", mode!=\"idle\"\
      }[5m])\n  * on(instance) group_left(node)\n  label_replace(kube_node_info{job=\"\
      kube-state-metrics\", node!~\".*master.*\"}, \"instance\", \"$1\", \"node\"\
      , \"(.*)\")\n)\n"
  - record: cluster_cpu_non_master_utilisation
    expr: 'cluster_cpu_non_master_usage / cluster_cpu_non_master_total

      '
  - record: cluster_pod_cpu_requests_total
    expr: 'sum(kube_pod_container_resource_requests{job="kube-state-metrics", resource="cpu"})

      '
  - record: cluster_pod_cpu_limits_total
    expr: 'sum(kube_pod_container_resource_limits{job="kube-state-metrics", resource="cpu"})

      '
- name: cluster-memory-metrics
  interval: 30s
  rules:
  - record: cluster_memory_total
    expr: 'sum(kube_node_status_allocatable{job="kube-state-metrics", resource="memory"})

      '
  - record: cluster_memory_available
    expr: 'sum(node_memory_MemAvailable_bytes{job="node-exporter"})

      '
  - record: cluster_memory_usage
    expr: 'sum(node_memory_MemTotal_bytes{job="node-exporter"} - node_memory_MemAvailable_bytes{job="node-exporter"})

      '
  - record: cluster_memory_utilisation
    expr: 'cluster_memory_usage / cluster_memory_total

      '
  - record: cluster_memory_master_total
    expr: "sum(\n  node_memory_MemTotal_bytes{job=\"node-exporter\"}\n  * on(instance)\
      \ group_left(node)\n  label_replace(kube_node_info{job=\"kube-state-metrics\"\
      , node=~\".*master.*\"}, \"instance\", \"$1\", \"node\", \"(.*)\")\n)\n"
  - record: cluster_memory_master_usage
    expr: "sum(\n  (node_memory_MemTotal_bytes{job=\"node-exporter\"} - node_memory_MemAvailable_bytes{job=\"\
      node-exporter\"})\n  * on(instance) group_left(node)\n  label_replace(kube_node_info{job=\"\
      kube-state-metrics\", node=~\".*master.*\"}, \"instance\", \"$1\", \"node\"\
      , \"(.*)\")\n)\n"
  - record: cluster_memory_master_utilisation
    expr: 'cluster_memory_master_usage / cluster_memory_master_total

      '
  - record: cluster_memory_non_master_total
    expr: "sum(\n  node_memory_MemTotal_bytes{job=\"node-exporter\"}\n  * on(instance)\
      \ group_left(node)\n  label_replace(kube_node_info{job=\"kube-state-metrics\"\
      , node!~\".*master.*\"}, \"instance\", \"$1\", \"node\", \"(.*)\")\n)\n"
  - record: cluster_memory_non_master_usage
    expr: "sum(\n  (node_memory_MemTotal_bytes{job=\"node-exporter\"} - node_memory_MemAvailable_bytes{job=\"\
      node-exporter\"})\n  * on(instance) group_left(node)\n  label_replace(kube_node_info{job=\"\
      kube-state-metrics\", node!~\".*master.*\"}, \"instance\", \"$1\", \"node\"\
      , \"(.*)\")\n)\n"
  - record: cluster_memory_non_master_utilisation
    expr: 'cluster_memory_non_master_usage / cluster_memory_non_master_total

      '
  - record: cluster_pod_memory_requests_total
    expr: 'sum(kube_pod_container_resource_requests{job="kube-state-metrics", resource="memory"})

      '
  - record: cluster_pod_memory_limits_total
    expr: 'sum(kube_pod_container_resource_limits{job="kube-state-metrics", resource="memory"})

      '
- name: cluster-disk-metrics
  interval: 30s
  rules:
  - record: cluster_disk_size_capacity
    expr: 'sum(node_filesystem_size_bytes{job="node-exporter", mountpoint="/", fstype!~"tmpfs|fuse.*"})

      '
  - record: cluster_disk_size_available
    expr: 'sum(node_filesystem_avail_bytes{job="node-exporter", mountpoint="/", fstype!~"tmpfs|fuse.*"})

      '
  - record: cluster_disk_size_usage
    expr: 'cluster_disk_size_capacity - cluster_disk_size_available

      '
  - record: cluster_disk_inode_total
    expr: 'sum(node_filesystem_files{job="node-exporter", mountpoint="/", fstype!~"tmpfs|fuse.*"})

      '
  - record: cluster_disk_inode_usage
    expr: "sum(\n  node_filesystem_files{job=\"node-exporter\", mountpoint=\"/\",\
      \ fstype!~\"tmpfs|fuse.*\"}\n  -\n  node_filesystem_files_free{job=\"node-exporter\"\
      , mountpoint=\"/\", fstype!~\"tmpfs|fuse.*\"}\n)\n"
- name: cluster-node-metrics
  interval: 30s
  rules:
  - record: cluster_node_total
    expr: 'count(kube_node_info{job="kube-state-metrics"})

      '
  - record: cluster_node_master_count
    expr: 'count(kube_node_info{job="kube-state-metrics", node=~".*master.*"})

      '
  - record: cluster_node_online
    expr: 'count(kube_node_status_condition{job="kube-state-metrics", condition="Ready",
      status="true"})

      '
  - record: cluster_node_offline
    expr: 'cluster_node_total - cluster_node_online

      '
- name: cluster-pod-metrics
  interval: 30s
  rules:
  - record: cluster_pod_quota
    expr: 'sum(kube_node_status_allocatable{job="kube-state-metrics", resource="pods"})

      '
  - record: cluster_pod_running_count
    expr: 'count(kube_pod_status_phase{job="kube-state-metrics", phase="Running"})

      '
  - record: cluster_pod_count
    expr: 'count(kube_pod_info{job="kube-state-metrics"})

      '
- name: cluster-network-metrics
  interval: 30s
  rules:
  - record: cluster_net_bytes_received
    expr: 'sum(rate(node_network_receive_bytes_total{job="node-exporter", device!~"lo|veth.*|docker.*|br.*"}[5m]))

      '
  - record: cluster_net_bytes_transmitted
    expr: 'sum(rate(node_network_transmit_bytes_total{job="node-exporter", device!~"lo|veth.*|docker.*|br.*"}[5m]))

      '
- name: workspace-aggregation-rules
  interval: 30s
  rules:
  - record: workspace:container_cpu_usage_seconds:sum_rate
    expr: "sum by (cluster, workspace) (\n  irate(container_cpu_usage_seconds_total{job=\"\
      kubelet\", container!=\"POD\", container!=\"\", image!=\"\"}[5m])\n  * on(namespace)\
      \ group_left(workspace)\n  label_replace(\n    kube_namespace_labels{label_theriseunion_io_workspace!=\"\
      \"},\n    \"workspace\", \"$1\", \"label_theriseunion_io_workspace\", \"(.*)\"\
      \n  )\n)\n"
  - record: workspace:container_memory_usage_bytes:sum
    expr: "sum by (cluster, workspace) (\n  container_memory_usage_bytes{job=\"kubelet\"\
      , container!=\"POD\", container!=\"\", image!=\"\"}\n  * on(namespace) group_left(workspace)\n\
      \  label_replace(\n    kube_namespace_labels{label_theriseunion_io_workspace!=\"\
      \"},\n    \"workspace\", \"$1\", \"label_theriseunion_io_workspace\", \"(.*)\"\
      \n  )\n)\n"
  - record: workspace:container_memory_rss:sum
    expr: "sum by (cluster, workspace) (\n  container_memory_rss{job=\"kubelet\",\
      \ container!=\"POD\", container!=\"\", image!=\"\"}\n  * on(namespace) group_left(workspace)\n\
      \  label_replace(\n    kube_namespace_labels{label_theriseunion_io_workspace!=\"\
      \"},\n    \"workspace\", \"$1\", \"label_theriseunion_io_workspace\", \"(.*)\"\
      \n  )\n)\n"
  - record: workspace:kube_pod_info:count
    expr: "count by (cluster, workspace) (\n  kube_pod_info{job=\"kube-state-metrics\"\
      }\n  * on(namespace) group_left(workspace)\n  label_replace(\n    kube_namespace_labels{label_theriseunion_io_workspace!=\"\
      \"},\n    \"workspace\", \"$1\", \"label_theriseunion_io_workspace\", \"(.*)\"\
      \n  )\n)\n"
  - record: workspace:kube_namespace:count
    expr: "count by (cluster, workspace) (\n  label_replace(\n    kube_namespace_labels{label_theriseunion_io_workspace!=\"\
      \"},\n    \"workspace\", \"$1\", \"label_theriseunion_io_workspace\", \"(.*)\"\
      \n  )\n)\n"
  - record: workspace:container_network_receive_bytes:sum_rate
    expr: "sum by (cluster, workspace) (\n  irate(container_network_receive_bytes_total{job=\"\
      kubelet\", interface!=\"lo\"}[5m])\n  * on(namespace) group_left(workspace)\n\
      \  label_replace(\n    kube_namespace_labels{label_theriseunion_io_workspace!=\"\
      \"},\n    \"workspace\", \"$1\", \"label_theriseunion_io_workspace\", \"(.*)\"\
      \n  )\n)\n"
  - record: workspace:container_network_transmit_bytes:sum_rate
    expr: "sum by (cluster, workspace) (\n  irate(container_network_transmit_bytes_total{job=\"\
      kubelet\", interface!=\"lo\"}[5m])\n  * on(namespace) group_left(workspace)\n\
      \  label_replace(\n    kube_namespace_labels{label_theriseunion_io_workspace!=\"\
      \"},\n    \"workspace\", \"$1\", \"label_theriseunion_io_workspace\", \"(.*)\"\
      \n  )\n)\n"
  - record: workspace:container_network_receive_packets:sum_rate
    expr: "sum by (cluster, workspace) (\n  irate(container_network_receive_packets_total{job=\"\
      kubelet\", interface!=\"lo\"}[5m])\n  * on(namespace) group_left(workspace)\n\
      \  label_replace(\n    kube_namespace_labels{label_theriseunion_io_workspace!=\"\
      \"},\n    \"workspace\", \"$1\", \"label_theriseunion_io_workspace\", \"(.*)\"\
      \n  )\n)\n"
  - record: workspace:container_network_transmit_packets:sum_rate
    expr: "sum by (cluster, workspace) (\n  irate(container_network_transmit_packets_total{job=\"\
      kubelet\", interface!=\"lo\"}[5m])\n  * on(namespace) group_left(workspace)\n\
      \  label_replace(\n    kube_namespace_labels{label_theriseunion_io_workspace!=\"\
      \"},\n    \"workspace\", \"$1\", \"label_theriseunion_io_workspace\", \"(.*)\"\
      \n  )\n)\n"
  - record: workspace:container_fs_reads:sum_rate
    expr: "sum by (cluster, workspace) (\n  irate(container_fs_reads_total{job=\"\
      kubelet\"}[5m])\n  * on(namespace) group_left(workspace)\n  label_replace(\n\
      \    kube_namespace_labels{label_theriseunion_io_workspace!=\"\"},\n    \"workspace\"\
      , \"$1\", \"label_theriseunion_io_workspace\", \"(.*)\"\n  )\n)\n"
  - record: workspace:container_fs_writes:sum_rate
    expr: "sum by (cluster, workspace) (\n  irate(container_fs_writes_total{job=\"\
      kubelet\"}[5m])\n  * on(namespace) group_left(workspace)\n  label_replace(\n\
      \    kube_namespace_labels{label_theriseunion_io_workspace!=\"\"},\n    \"workspace\"\
      , \"$1\", \"label_theriseunion_io_workspace\", \"(.*)\"\n  )\n)\n"
  - record: workspace:container_fs_reads_bytes:sum_rate
    expr: "sum by (cluster, workspace) (\n  irate(container_fs_reads_bytes_total{job=\"\
      kubelet\"}[5m])\n  * on(namespace) group_left(workspace)\n  label_replace(\n\
      \    kube_namespace_labels{label_theriseunion_io_workspace!=\"\"},\n    \"workspace\"\
      , \"$1\", \"label_theriseunion_io_workspace\", \"(.*)\"\n  )\n)\n"
  - record: workspace:container_fs_writes_bytes:sum_rate
    expr: "sum by (cluster, workspace) (\n  irate(container_fs_writes_bytes_total{job=\"\
      kubelet\"}[5m])\n  * on(namespace) group_left(workspace)\n  label_replace(\n\
      \    kube_namespace_labels{label_theriseunion_io_workspace!=\"\"},\n    \"workspace\"\
      , \"$1\", \"label_theriseunion_io_workspace\", \"(.*)\"\n  )\n)\n"
  - record: workspace:kube_pod_container_resource_requests_memory:sum
    expr: "sum by (cluster, workspace) (\n  kube_pod_container_resource_requests{job=\"\
      kube-state-metrics\", resource=\"memory\"}\n  * on(namespace) group_left(workspace)\n\
      \  label_replace(\n    kube_namespace_labels{label_theriseunion_io_workspace!=\"\
      \"},\n    \"workspace\", \"$1\", \"label_theriseunion_io_workspace\", \"(.*)\"\
      \n  )\n)\n"
  - record: workspace:kube_pod_container_resource_limits_memory:sum
    expr: "sum by (cluster, workspace) (\n  kube_pod_container_resource_limits{job=\"\
      kube-state-metrics\", resource=\"memory\"}\n  * on(namespace) group_left(workspace)\n\
      \  label_replace(\n    kube_namespace_labels{label_theriseunion_io_workspace!=\"\
      \"},\n    \"workspace\", \"$1\", \"label_theriseunion_io_workspace\", \"(.*)\"\
      \n  )\n)\n"
  - record: workspace:kube_pod_container_resource_requests_cpu:sum
    expr: "sum by (cluster, workspace) (\n  kube_pod_container_resource_requests{job=\"\
      kube-state-metrics\", resource=\"cpu\"}\n  * on(namespace) group_left(workspace)\n\
      \  label_replace(\n    kube_namespace_labels{label_theriseunion_io_workspace!=\"\
      \"},\n    \"workspace\", \"$1\", \"label_theriseunion_io_workspace\", \"(.*)\"\
      \n  )\n)\n"
  - record: workspace:kube_pod_container_resource_limits_cpu:sum
    expr: "sum by (cluster, workspace) (\n  kube_pod_container_resource_limits{job=\"\
      kube-state-metrics\", resource=\"cpu\"}\n  * on(namespace) group_left(workspace)\n\
      \  label_replace(\n    kube_namespace_labels{label_theriseunion_io_workspace!=\"\
      \"},\n    \"workspace\", \"$1\", \"label_theriseunion_io_workspace\", \"(.*)\"\
      \n  )\n)\n"
  - record: workspace:kube_deployment:count
    expr: "count by (cluster, workspace) (\n  kube_deployment_spec_replicas{job=\"\
      kube-state-metrics\"}\n  * on(namespace) group_left(workspace)\n  label_replace(\n\
      \    kube_namespace_labels{label_theriseunion_io_workspace!=\"\"},\n    \"workspace\"\
      , \"$1\", \"label_theriseunion_io_workspace\", \"(.*)\"\n  )\n)\n"
  - record: workspace:kube_statefulset:count
    expr: "count by (cluster, workspace) (\n  kube_statefulset_replicas{job=\"kube-state-metrics\"\
      }\n  * on(namespace) group_left(workspace)\n  label_replace(\n    kube_namespace_labels{label_theriseunion_io_workspace!=\"\
      \"},\n    \"workspace\", \"$1\", \"label_theriseunion_io_workspace\", \"(.*)\"\
      \n  )\n)\n"
  - record: workspace:kube_daemonset:count
    expr: "count by (cluster, workspace) (\n  kube_daemonset_status_desired_number_scheduled{job=\"\
      kube-state-metrics\"}\n  * on(namespace) group_left(workspace)\n  label_replace(\n\
      \    kube_namespace_labels{label_theriseunion_io_workspace!=\"\"},\n    \"workspace\"\
      , \"$1\", \"label_theriseunion_io_workspace\", \"(.*)\"\n  )\n)\n"
  - record: workspace:kube_job:count
    expr: "count by (cluster, workspace) (\n  kube_job_info{job=\"kube-state-metrics\"\
      }\n  * on(namespace) group_left(workspace)\n  label_replace(\n    kube_namespace_labels{label_theriseunion_io_workspace!=\"\
      \"},\n    \"workspace\", \"$1\", \"label_theriseunion_io_workspace\", \"(.*)\"\
      \n  )\n)\n"
  - record: workspace:kube_cronjob:count
    expr: "count by (cluster, workspace) (\n  kube_cronjob_info{job=\"kube-state-metrics\"\
      }\n  * on(namespace) group_left(workspace)\n  label_replace(\n    kube_namespace_labels{label_theriseunion_io_workspace!=\"\
      \"},\n    \"workspace\", \"$1\", \"label_theriseunion_io_workspace\", \"(.*)\"\
      \n  )\n)\n"
  - record: workspace:memory_utilization_percent
    expr: "(\n  workspace:container_memory_usage_bytes:sum\n  /\n  workspace:kube_pod_container_resource_requests_memory:sum\n\
      ) * 100\n"
  - record: workspace:cpu_utilization_percent
    expr: "(\n  workspace:container_cpu_usage_seconds:sum_rate\n  /\n  workspace:kube_pod_container_resource_requests_cpu:sum\n\
      ) * 100\n"
  - record: workspace:kube_persistentvolumeclaim:count
    expr: "count by (cluster, workspace) (\n  kube_persistentvolumeclaim_info{job=\"\
      kube-state-metrics\"}\n  * on(namespace) group_left(workspace)\n  label_replace(\n\
      \    kube_namespace_labels{label_theriseunion_io_workspace!=\"\"},\n    \"workspace\"\
      , \"$1\", \"label_theriseunion_io_workspace\", \"(.*)\"\n  )\n)\n"
  - record: workspace:kube_persistentvolumeclaim_bound:count
    expr: "count by (cluster, workspace) (\n  kube_persistentvolumeclaim_status_phase{job=\"\
      kube-state-metrics\", phase=\"Bound\"}\n  * on(namespace, persistentvolumeclaim)\
      \ group_left()\n  kube_persistentvolumeclaim_info{job=\"kube-state-metrics\"\
      }\n  * on(namespace) group_left(workspace)\n  label_replace(\n    kube_namespace_labels{label_theriseunion_io_workspace!=\"\
      \"},\n    \"workspace\", \"$1\", \"label_theriseunion_io_workspace\", \"(.*)\"\
      \n  )\n)\n"
  - record: workspace:kube_persistentvolumeclaim_pending:count
    expr: "count by (cluster, workspace) (\n  kube_persistentvolumeclaim_status_phase{job=\"\
      kube-state-metrics\", phase=\"Pending\"}\n  * on(namespace, persistentvolumeclaim)\
      \ group_left()\n  kube_persistentvolumeclaim_info{job=\"kube-state-metrics\"\
      }\n  * on(namespace) group_left(workspace)\n  label_replace(\n    kube_namespace_labels{label_theriseunion_io_workspace!=\"\
      \"},\n    \"workspace\", \"$1\", \"label_theriseunion_io_workspace\", \"(.*)\"\
      \n  )\n)\n"
  - record: workspace:kube_persistentvolumeclaim_capacity_bytes:sum
    expr: "sum by (cluster, workspace) (\n  kube_persistentvolumeclaim_resource_requests_storage_bytes{job=\"\
      kube-state-metrics\"}\n  * on(namespace) group_left(workspace)\n  label_replace(\n\
      \    kube_namespace_labels{label_theriseunion_io_workspace!=\"\"},\n    \"workspace\"\
      , \"$1\", \"label_theriseunion_io_workspace\", \"(.*)\"\n  )\n)\n"
  - record: workspace:kube_persistentvolumeclaim_bound_capacity_bytes:sum
    expr: "sum by (cluster, workspace) (\n  kube_persistentvolumeclaim_resource_requests_storage_bytes{job=\"\
      kube-state-metrics\"}\n  * on(namespace, persistentvolumeclaim) group_left()\n\
      \  kube_persistentvolumeclaim_status_phase{job=\"kube-state-metrics\", phase=\"\
      Bound\"}\n  * on(namespace) group_left(workspace)\n  label_replace(\n    kube_namespace_labels{label_theriseunion_io_workspace!=\"\
      \"},\n    \"workspace\", \"$1\", \"label_theriseunion_io_workspace\", \"(.*)\"\
      \n  )\n)\n"
  - record: workspace:kube_persistentvolume:count
    expr: "count by (cluster, workspace) (\n  kube_persistentvolume_claim_ref{job=\"\
      kube-state-metrics\"}\n  * on(namespace) group_left(workspace)\n  label_replace(\n\
      \    kube_namespace_labels{label_theriseunion_io_workspace!=\"\"},\n    \"workspace\"\
      , \"$1\", \"label_theriseunion_io_workspace\", \"(.*)\"\n  )\n)\n"
  - record: workspace:kube_storageclass:count
    expr: "count by (cluster, workspace) (\n  group by (cluster, workspace, storageclass)\
      \ (\n    kube_persistentvolumeclaim_info{job=\"kube-state-metrics\"}\n    *\
      \ on(namespace) group_left(workspace)\n    label_replace(\n      kube_namespace_labels{label_theriseunion_io_workspace!=\"\
      \"},\n      \"workspace\", \"$1\", \"label_theriseunion_io_workspace\", \"(.*)\"\
      \n    )\n  )\n)\n"
  - record: workspace:kube_persistentvolumeclaim_bytes_used:sum
    expr: "sum by (cluster, workspace) (\n  kubelet_volume_stats_used_bytes\n  * on(namespace)\
      \ group_left(workspace)\n  label_replace(\n    kube_namespace_labels{label_theriseunion_io_workspace!=\"\
      \"},\n    \"workspace\", \"$1\", \"label_theriseunion_io_workspace\", \"(.*)\"\
      \n  )\n)\n"
- name: namespace-aggregation-rules
  interval: 30s
  rules:
  - record: namespace:kube_pod:count
    expr: "count by (cluster, namespace) (\n  kube_pod_info\n)\n"
  - record: namespace:kube_deployment:count
    expr: "count by (cluster, namespace) (\n  kube_deployment_spec_replicas\n)\n"
  - record: namespace:kube_statefulset:count
    expr: "count by (cluster, namespace) (\n  kube_statefulset_replicas\n)\n"
  - record: namespace:kube_daemonset:count
    expr: "count by (cluster, namespace) (\n  kube_daemonset_status_desired_number_scheduled\n\
      )\n"
  - record: namespace:kube_job:count
    expr: "count by (cluster, namespace) (\n  kube_job_info\n)\n"
  - record: namespace:kube_cronjob:count
    expr: "count by (cluster, namespace) (\n  kube_cronjob_info\n)\n"
  - record: namespace:kube_service:count
    expr: "count by (cluster, namespace) (\n  kube_service_info\n)\n"
  - record: namespace:container_cpu_usage_seconds:sum_rate
    expr: "sum by (cluster, namespace) (\n  irate(container_cpu_usage_seconds_total{container!=\"\
      POD\", container!=\"\", image!=\"\"}[5m])\n)\n"
  - record: namespace:container_memory_usage_bytes:sum
    expr: "sum by (cluster, namespace) (\n  container_memory_usage_bytes{container!=\"\
      POD\", container!=\"\", image!=\"\"}\n)\n"
  - record: namespace:container_network_receive_packets:sum_rate
    expr: "sum by (cluster, namespace) (\n  irate(container_network_receive_packets_total{interface!=\"\
      lo\"}[5m])\n)\n"
  - record: namespace:container_network_transmit_packets:sum_rate
    expr: "sum by (cluster, namespace) (\n  irate(container_network_transmit_packets_total{interface!=\"\
      lo\"}[5m])\n)\n"
- name: node-npu-metrics
  interval: 30s
  rules:
  - record: edge_node_npu_memory_total
    expr: "sum by (cluster, instance) (\n  npu_chip_info_memory_total\n)\n"
  - record: edge_node_npu_memory_usage
    expr: "sum by (cluster, instance) (\n  npu_chip_info_memory_usage\n)\n"
  - record: edge_node_npu_count
    expr: "count by (cluster, instance) (\n  npu_chip_info_memory_total\n)\n"
  - record: edge_node_npu_utilisation_avg
    expr: "avg by (cluster, instance) (\n  npu_chip_info_utilization\n)\n"
  - record: edge_node_npu_temperature_avg
    expr: "avg by (cluster, instance) (\n  npu_chip_info_temperature\n)\n"
  - record: edge_node_npu_power_total
    expr: "sum by (cluster, instance) (\n  npu_chip_info_power\n)\n"
- name: cluster-npu-metrics
  interval: 30s
  rules:
  - record: edge_cluster_npu_memory_total
    expr: 'sum(edge_node_npu_memory_total)

      '
  - record: edge_cluster_npu_memory_usage
    expr: 'sum(edge_node_npu_memory_usage)

      '
  - record: edge_cluster_npu_count
    expr: 'sum(edge_node_npu_count)

      '
  - record: edge_cluster_npu_utilisation_avg
    expr: 'avg(edge_node_npu_utilisation_avg)

      '
  - record: edge_cluster_npu_power_total
    expr: 'sum(edge_node_npu_power_total)

      '
