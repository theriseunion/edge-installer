apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: node-recording-rules
  namespace: observability-system
  labels:
    prometheus: kube-prometheus
    role: recording-rules
    release: edge-monitoring
    layer: node
spec:
  groups:
    # ========================================================================
    # Node-level Recording Rules
    # Purpose: Pre-aggregate node-level resource metrics for performance
    # Priority: P1 - Foundation for nodegroup and cluster aggregations
    # Dependencies: node-exporter, kube-state-metrics, cadvisor
    # ========================================================================
    - name: node-cpu-metrics
      interval: 30s
      rules:
        # Node CPU total cores
        - record: node_cpu_total
          expr: |
            count by (cluster, instance) (
              node_cpu_seconds_total{job="node-exporter", mode="idle"}
            )

        # Node CPU usage (cores in use)
        - record: node_cpu_usage
          expr: |
            sum by (cluster, instance) (
              rate(node_cpu_seconds_total{job="node-exporter", mode!="idle"}[5m])
            )

        # Node CPU utilisation (0-1 ratio)
        - record: node_cpu_utilisation
          expr: |
            node_cpu_usage / node_cpu_total

        # Node CPU allocatable (from K8s)
        - record: node_cpu_allocatable_total
          expr: |
            kube_node_status_allocatable{job="kube-state-metrics", resource="cpu"}

    - name: node-memory-metrics
      interval: 30s
      rules:
        # Node memory total
        - record: node_memory_total
          expr: |
            node_memory_MemTotal_bytes{job="node-exporter"}

        # Node memory available
        - record: node_memory_available
          expr: |
            node_memory_MemAvailable_bytes{job="node-exporter"}

        # Node memory usage
        - record: node_memory_usage
          expr: |
            node_memory_MemTotal_bytes{job="node-exporter"}
            -
            node_memory_MemAvailable_bytes{job="node-exporter"}

        # Node memory utilisation (0-1 ratio)
        - record: node_memory_utilisation
          expr: |
            node_memory_usage / node_memory_total

        # Node memory allocatable (from K8s)
        - record: node_memory_allocatable_total
          expr: |
            kube_node_status_allocatable{job="kube-state-metrics", resource="memory"}

    - name: node-disk-metrics
      interval: 30s
      rules:
        # Node disk capacity (bytes) - root filesystem only
        - record: node_disk_size_capacity
          expr: |
            sum by (cluster, instance) (
              node_filesystem_size_bytes{job="node-exporter", mountpoint="/", fstype!~"tmpfs|fuse.*"}
            )

        # Node disk available (bytes)
        - record: node_disk_size_available
          expr: |
            sum by (cluster, instance) (
              node_filesystem_avail_bytes{job="node-exporter", mountpoint="/", fstype!~"tmpfs|fuse.*"}
            )

        # Node disk usage (bytes)
        - record: node_disk_size_usage
          expr: |
            node_disk_size_capacity - node_disk_size_available

        # Node disk inode total
        - record: node_disk_inode_total
          expr: |
            sum by (cluster, instance) (
              node_filesystem_files{job="node-exporter", mountpoint="/", fstype!~"tmpfs|fuse.*"}
            )

        # Node disk inode usage
        - record: node_disk_inode_usage
          expr: |
            sum by (cluster, instance) (
              node_filesystem_files{job="node-exporter", mountpoint="/", fstype!~"tmpfs|fuse.*"}
              -
              node_filesystem_files_free{job="node-exporter", mountpoint="/", fstype!~"tmpfs|fuse.*"}
            )

        # Node ephemeral storage allocatable
        - record: node_ephemeral_storage_allocatable_total
          expr: |
            kube_node_status_allocatable{job="kube-state-metrics", resource="ephemeral-storage"}

    - name: node-pod-metrics
      interval: 30s
      rules:
        # Node pod count
        - record: node_pod_count
          expr: |
            count by (cluster, node) (
              kube_pod_info{job="kube-state-metrics"}
            )

        # Node pod quota (max pods)
        - record: node_pod_quota
          expr: |
            kube_node_status_allocatable{job="kube-state-metrics", resource="pods"}

        # Node pod CPU requests total
        - record: node_pod_requests_cpu_total
          expr: |
            sum by (cluster, node) (
              kube_pod_container_resource_requests{job="kube-state-metrics", resource="cpu"}
              * on(cluster, namespace, pod) group_left(node)
              kube_pod_info{job="kube-state-metrics"}
            )

        # Node pod CPU limits total
        - record: node_pod_limits_cpu_total
          expr: |
            sum by (cluster, node) (
              kube_pod_container_resource_limits{job="kube-state-metrics", resource="cpu"}
              * on(cluster, namespace, pod) group_left(node)
              kube_pod_info{job="kube-state-metrics"}
            )

        # Node pod memory requests total
        - record: node_pod_requests_memory_total
          expr: |
            sum by (cluster, node) (
              kube_pod_container_resource_requests{job="kube-state-metrics", resource="memory"}
              * on(cluster, namespace, pod) group_left(node)
              kube_pod_info{job="kube-state-metrics"}
            )

        # Node pod memory limits total
        - record: node_pod_limits_memory_total
          expr: |
            sum by (cluster, node) (
              kube_pod_container_resource_limits{job="kube-state-metrics", resource="memory"}
              * on(cluster, namespace, pod) group_left(node)
              kube_pod_info{job="kube-state-metrics"}
            )

        # Node pod ephemeral storage requests total
        - record: node_pod_requests_ephemeral_storage_total
          expr: |
            sum by (cluster, node) (
              kube_pod_container_resource_requests{job="kube-state-metrics", resource="ephemeral-storage"}
              * on(cluster, namespace, pod) group_left(node)
              kube_pod_info{job="kube-state-metrics"}
            )
