apiVersion: v1
data:
  recording-rules.yaml: |
    groups:
      # Node-level recording rules for CPU and Memory utilization metrics
      - name: node-resource-utilization-rules
        interval: 30s
        rules:
          # Node-level CPU usage aggregation by node
          - record: node_namespace_pod_container:container_cpu_usage_seconds_total:sum_irate
            expr: |
              sum by (cluster, node) (
                irate(container_cpu_usage_seconds_total{job="kubelet", metrics_path="/metrics/cadvisor", container!="", image!=""}[5m])
              )

          # Node-level memory working set aggregation by node
          - record: node_namespace_pod_container:container_memory_working_set_bytes
            expr: |
              sum by (cluster, node) (
                container_memory_working_set_bytes{job="kubelet", metrics_path="/metrics/cadvisor", container!="", image!=""}
              )

          # CPU requests by node - with fallback handling
          - record: cluster:namespace:pod_cpu:active:kube_pod_container_resource_requests
            expr: |
              sum by (cluster, node) (
                (
                  kube_pod_container_resource_requests{job="kube-state-metrics", resource="cpu", unit="core"}
                  * on (cluster, namespace, pod) group_left(node)
                  kube_pod_info{job="kube-state-metrics"}
                ) or on (cluster, node) (
                  # Fallback: use kube_pod_container_resource_requests without unit filter
                  sum by (cluster, node) (
                    kube_pod_container_resource_requests{job="kube-state-metrics", resource="cpu"}
                    * on (cluster, namespace, pod) group_left(node)
                    kube_pod_info{job="kube-state-metrics"}
                  )
                )
              )

          # CPU limits by node - with fallback handling
          - record: cluster:namespace:pod_cpu:active:kube_pod_container_resource_limits
            expr: |
              sum by (cluster, node) (
                (
                  kube_pod_container_resource_limits{job="kube-state-metrics", resource="cpu", unit="core"}
                  * on (cluster, namespace, pod) group_left(node)
                  kube_pod_info{job="kube-state-metrics"}
                ) or on (cluster, node) (
                  # Fallback: use kube_pod_container_resource_limits without unit filter
                  sum by (cluster, node) (
                    kube_pod_container_resource_limits{job="kube-state-metrics", resource="cpu"}
                    * on (cluster, namespace, pod) group_left(node)
                    kube_pod_info{job="kube-state-metrics"}
                  )
                )
              )

          # Memory requests by node - with fallback handling
          - record: cluster:namespace:pod_memory:active:kube_pod_container_resource_requests
            expr: |
              sum by (cluster, node) (
                (
                  kube_pod_container_resource_requests{job="kube-state-metrics", resource="memory", unit="byte"}
                  * on (cluster, namespace, pod) group_left(node)
                  kube_pod_info{job="kube-state-metrics"}
                ) or on (cluster, node) (
                  # Fallback: use kube_pod_container_resource_requests without unit filter
                  sum by (cluster, node) (
                    kube_pod_container_resource_requests{job="kube-state-metrics", resource="memory"}
                    * on (cluster, namespace, pod) group_left(node)
                    kube_pod_info{job="kube-state-metrics"}
                  )
                )
              )

          # Memory limits by node - with fallback handling
          - record: cluster:namespace:pod_memory:active:kube_pod_container_resource_limits
            expr: |
              sum by (cluster, node) (
                (
                  kube_pod_container_resource_limits{job="kube-state-metrics", resource="memory", unit="byte"}
                  * on (cluster, namespace, pod) group_left(node)
                  kube_pod_info{job="kube-state-metrics"}
                ) or on (cluster, node) (
                  # Fallback: use kube_pod_container_resource_limits without unit filter
                  sum by (cluster, node) (
                    kube_pod_container_resource_limits{job="kube-state-metrics", resource="memory"}
                    * on (cluster, namespace, pod) group_left(node)
                    kube_pod_info{job="kube-state-metrics"}
                  )
                )
              )

      # Additional recording rules for cluster-level aggregations that may be missing
      - name: cluster-resource-aggregation-rules
        interval: 30s
        rules:
          # Cluster-level CPU requests total
          - record: namespace_cpu:kube_pod_container_resource_requests:sum
            expr: |
              sum by (cluster, namespace) (
                kube_pod_container_resource_requests{job="kube-state-metrics", resource="cpu", unit="core"}
              )

          # Cluster-level CPU limits total
          - record: namespace_cpu:kube_pod_container_resource_limits:sum
            expr: |
              sum by (cluster, namespace) (
                kube_pod_container_resource_limits{job="kube-state-metrics", resource="cpu", unit="core"}
              )

          # Cluster-level memory requests total
          - record: namespace_memory:kube_pod_container_resource_requests:sum
            expr: |
              sum by (cluster, namespace) (
                kube_pod_container_resource_requests{job="kube-state-metrics", resource="memory", unit="byte"}
              )

          # Cluster-level memory limits total
          - record: namespace_memory:kube_pod_container_resource_limits:sum
            expr: |
              sum by (cluster, namespace) (
                kube_pod_container_resource_limits{job="kube-state-metrics", resource="memory", unit="byte"}
              )

          # Node memory available bytes
          - record: :node_memory_MemAvailable_bytes:sum
            expr: |
              sum by (cluster, instance) (
                node_memory_MemAvailable_bytes{job="node-exporter"}
              )

      # Workload-level recording rules for namespace_workload_pod metrics
      - name: workload-aggregation-rules
        interval: 30s
        rules:
          # Create workload-level metric with proper labels for cluster workload count
          - record: namespace_workload_pod:kube_pod_owner:relabel
            expr: |
              label_replace(
                kube_pod_info{job="kube-state-metrics"},
                "workload",
                "$1",
                "created_by_name",
                "(.*)"
              )

      # Workspace-level aggregation recording rules
      - name: workspace-aggregation-rules
        interval: 30s
        rules:
          # =====================================================
          # CPU metrics (aggregated by workspace)
          # =====================================================

          - record: workspace:container_cpu_usage_seconds:sum_rate
            expr: |
              sum by (workspace) (
                irate(container_cpu_usage_seconds_total{container!="POD", container!="", image!=""}[5m])
                * on(namespace) group_left(workspace)
                label_replace(
                  kube_namespace_labels{label_theriseunion_io_workspace!=""},
                  "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
                )
              )

          # =====================================================
          # Memory metrics (aggregated by workspace)
          # =====================================================

          - record: workspace:container_memory_usage_bytes:sum
            expr: |
              sum by (workspace) (
                container_memory_usage_bytes{container!="POD", container!="", image!=""}
                * on(namespace) group_left(workspace)
                label_replace(
                  kube_namespace_labels{label_theriseunion_io_workspace!=""},
                  "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
                )
              )

          - record: workspace:container_memory_rss:sum
            expr: |
              sum by (workspace) (
                container_memory_rss{container!="POD", container!="", image!=""}
                * on(namespace) group_left(workspace)
                label_replace(
                  kube_namespace_labels{label_theriseunion_io_workspace!=""},
                  "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
                )
              )

          # =====================================================
          # Pod count (aggregated by workspace)
          # =====================================================

          - record: workspace:kube_pod_info:count
            expr: |
              count by (workspace) (
                kube_pod_info
                * on(namespace) group_left(workspace)
                label_replace(
                  kube_namespace_labels{label_theriseunion_io_workspace!=""},
                  "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
                )
              )

          # =====================================================
          # Namespace count (aggregated by workspace)
          # =====================================================

          - record: workspace:kube_namespace:count
            expr: |
              count by (workspace) (
                label_replace(
                  kube_namespace_labels{label_theriseunion_io_workspace!=""},
                  "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
                )
              )

          # =====================================================
          # Network metrics (aggregated by workspace)
          # =====================================================

          - record: workspace:container_network_receive_bytes:sum_rate
            expr: |
              sum by (workspace) (
                irate(container_network_receive_bytes_total{interface!="lo"}[5m])
                * on(namespace) group_left(workspace)
                label_replace(
                  kube_namespace_labels{label_theriseunion_io_workspace!=""},
                  "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
                )
              )

          - record: workspace:container_network_transmit_bytes:sum_rate
            expr: |
              sum by (workspace) (
                irate(container_network_transmit_bytes_total{interface!="lo"}[5m])
                * on(namespace) group_left(workspace)
                label_replace(
                  kube_namespace_labels{label_theriseunion_io_workspace!=""},
                  "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
                )
              )

          - record: workspace:container_network_receive_packets:sum_rate
            expr: |
              sum by (workspace) (
                irate(container_network_receive_packets_total{interface!="lo"}[5m])
                * on(namespace) group_left(workspace)
                label_replace(
                  kube_namespace_labels{label_theriseunion_io_workspace!=""},
                  "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
                )
              )

          - record: workspace:container_network_transmit_packets:sum_rate
            expr: |
              sum by (workspace) (
                irate(container_network_transmit_packets_total{interface!="lo"}[5m])
                * on(namespace) group_left(workspace)
                label_replace(
                  kube_namespace_labels{label_theriseunion_io_workspace!=""},
                  "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
                )
              )

          # =====================================================
          # Disk I/O metrics (aggregated by workspace)
          # =====================================================

          - record: workspace:container_fs_reads:sum_rate
            expr: |
              sum by (workspace) (
                irate(container_fs_reads_total[5m])
                * on(namespace) group_left(workspace)
                label_replace(
                  kube_namespace_labels{label_theriseunion_io_workspace!=""},
                  "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
                )
              )

          - record: workspace:container_fs_writes:sum_rate
            expr: |
              sum by (workspace) (
                irate(container_fs_writes_total[5m])
                * on(namespace) group_left(workspace)
                label_replace(
                  kube_namespace_labels{label_theriseunion_io_workspace!=""},
                  "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
                )
              )

          - record: workspace:container_fs_reads_bytes:sum_rate
            expr: |
              sum by (workspace) (
                irate(container_fs_reads_bytes_total[5m])
                * on(namespace) group_left(workspace)
                label_replace(
                  kube_namespace_labels{label_theriseunion_io_workspace!=""},
                  "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
                )
              )

          - record: workspace:container_fs_writes_bytes:sum_rate
            expr: |
              sum by (workspace) (
                irate(container_fs_writes_bytes_total[5m])
                * on(namespace) group_left(workspace)
                label_replace(
                  kube_namespace_labels{label_theriseunion_io_workspace!=""},
                  "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
                )
              )

          # =====================================================
          # Resource Requests/Limits (aggregated by workspace)
          # =====================================================

          - record: workspace:kube_pod_container_resource_requests_memory:sum
            expr: |
              sum by (workspace) (
                kube_pod_container_resource_requests{resource="memory"}
                * on(namespace) group_left(workspace)
                label_replace(
                  kube_namespace_labels{label_theriseunion_io_workspace!=""},
                  "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
                )
              )

          - record: workspace:kube_pod_container_resource_limits_memory:sum
            expr: |
              sum by (workspace) (
                kube_pod_container_resource_limits{resource="memory"}
                * on(namespace) group_left(workspace)
                label_replace(
                  kube_namespace_labels{label_theriseunion_io_workspace!=""},
                  "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
                )
              )

          - record: workspace:kube_pod_container_resource_requests_cpu:sum
            expr: |
              sum by (workspace) (
                kube_pod_container_resource_requests{resource="cpu"}
                * on(namespace) group_left(workspace)
                label_replace(
                  kube_namespace_labels{label_theriseunion_io_workspace!=""},
                  "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
                )
              )

          - record: workspace:kube_pod_container_resource_limits_cpu:sum
            expr: |
              sum by (workspace) (
                kube_pod_container_resource_limits{resource="cpu"}
                * on(namespace) group_left(workspace)
                label_replace(
                  kube_namespace_labels{label_theriseunion_io_workspace!=""},
                  "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
                )
              )

          # ========================================================================
          # Edge Platform Extension: Workspace Workload Count Rules
          # Added by: Edge Team
          # Purpose: Pre-aggregate workload counts by workspace for performance
          # Dependencies: Requires kube-state-metrics with custom labels
          # ========================================================================

          # Workspace deployment count
          - record: workspace:kube_deployment:count
            expr: |
              count by (workspace) (
                kube_deployment_spec_replicas
                * on(namespace) group_left(workspace)
                label_replace(
                  kube_namespace_labels{label_theriseunion_io_workspace!=""},
                  "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
                )
              )

          # Workspace statefulset count
          - record: workspace:kube_statefulset:count
            expr: |
              count by (workspace) (
                kube_statefulset_replicas
                * on(namespace) group_left(workspace)
                label_replace(
                  kube_namespace_labels{label_theriseunion_io_workspace!=""},
                  "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
                )
              )

          # Workspace daemonset count
          - record: workspace:kube_daemonset:count
            expr: |
              count by (workspace) (
                kube_daemonset_status_desired_number_scheduled
                * on(namespace) group_left(workspace)
                label_replace(
                  kube_namespace_labels{label_theriseunion_io_workspace!=""},
                  "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
                )
              )

          # Workspace job count
          - record: workspace:kube_job:count
            expr: |
              count by (workspace) (
                kube_job_info
                * on(namespace) group_left(workspace)
                label_replace(
                  kube_namespace_labels{label_theriseunion_io_workspace!=""},
                  "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
                )
              )

          # Workspace cronjob count
          - record: workspace:kube_cronjob:count
            expr: |
              count by (workspace) (
                kube_cronjob_info
                * on(namespace) group_left(workspace)
                label_replace(
                  kube_namespace_labels{label_theriseunion_io_workspace!=""},
                  "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
                )
              )

          # =====================================================
          # Resource utilization (calculated by workspace)
          # =====================================================

          - record: workspace:memory_utilization_percent
            expr: |
              (
                workspace:container_memory_usage_bytes:sum
                /
                workspace:kube_pod_container_resource_requests_memory:sum
              ) * 100

          - record: workspace:cpu_utilization_percent
            expr: |
              (
                workspace:container_cpu_usage_seconds:sum_rate
                /
                workspace:kube_pod_container_resource_requests_cpu:sum
              ) * 100

      # NodeGroup-level aggregation recording rules
      - name: nodegroup-aggregation-rules
        interval: 30s
        rules:
          # =====================================================
          # Node count (aggregated by nodegroup)
          # =====================================================

          - record: nodegroup:kube_node_info:count
            expr: |
              count by (nodegroup) (
                kube_node_info
                * on(node) group_left(nodegroup)
                label_replace(
                  kube_node_labels{label_theriseunion_io_nodegroup!=""},
                  "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
                )
              )

          # =====================================================
          # CPU metrics (aggregated by nodegroup)
          # =====================================================

          - record: nodegroup:node_cpu_usage:sum_rate
            expr: |
              sum by (nodegroup) (
                (1 - avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])))
                * on(instance) group_left(node)
                label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
                * on(node) group_left(nodegroup)
                label_replace(
                  kube_node_labels{label_theriseunion_io_nodegroup!=""},
                  "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
                )
              )

          - record: nodegroup:machine_cpu_cores:sum
            expr: |
              sum by (nodegroup) (
                machine_cpu_cores
                * on(instance) group_left(node)
                label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
                * on(node) group_left(nodegroup)
                label_replace(
                  kube_node_labels{label_theriseunion_io_nodegroup!=""},
                  "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
                )
              )

          # =====================================================
          # Memory metrics (aggregated by nodegroup)
          # =====================================================

          - record: nodegroup:node_memory_usage_bytes:sum
            expr: |
              sum by (nodegroup) (
                (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes)
                * on(instance) group_left(node)
                label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
                * on(node) group_left(nodegroup)
                label_replace(
                  kube_node_labels{label_theriseunion_io_nodegroup!=""},
                  "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
                )
              )

          - record: nodegroup:node_memory_available_bytes:sum
            expr: |
              sum by (nodegroup) (
                node_memory_MemAvailable_bytes
                * on(instance) group_left(node)
                label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
                * on(node) group_left(nodegroup)
                label_replace(
                  kube_node_labels{label_theriseunion_io_nodegroup!=""},
                  "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
                )
              )

          - record: nodegroup:node_memory_total_bytes:sum
            expr: |
              sum by (nodegroup) (
                node_memory_MemTotal_bytes
                * on(instance) group_left(node)
                label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
                * on(node) group_left(nodegroup)
                label_replace(
                  kube_node_labels{label_theriseunion_io_nodegroup!=""},
                  "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
                )
              )

          # =====================================================
          # Network metrics (aggregated by nodegroup)
          # =====================================================

          - record: nodegroup:node_network_receive_bytes:sum_rate
            expr: |
              sum by (nodegroup) (
                irate(node_network_receive_bytes_total{device!~"lo|veth.*|docker.*|br.*"}[5m])
                * on(instance) group_left(node)
                label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
                * on(node) group_left(nodegroup)
                label_replace(
                  kube_node_labels{label_theriseunion_io_nodegroup!=""},
                  "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
                )
              )

          - record: nodegroup:node_network_transmit_bytes:sum_rate
            expr: |
              sum by (nodegroup) (
                irate(node_network_transmit_bytes_total{device!~"lo|veth.*|docker.*|br.*"}[5m])
                * on(instance) group_left(node)
                label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
                * on(node) group_left(nodegroup)
                label_replace(
                  kube_node_labels{label_theriseunion_io_nodegroup!=""},
                  "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
                )
              )

          - record: nodegroup:node_network_receive_packets:sum_rate
            expr: |
              sum by (nodegroup) (
                irate(node_network_receive_packets_total{device!~"lo|veth.*|docker.*|br.*"}[5m])
                * on(instance) group_left(node)
                label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
                * on(node) group_left(nodegroup)
                label_replace(
                  kube_node_labels{label_theriseunion_io_nodegroup!=""},
                  "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
                )
              )

          - record: nodegroup:node_network_transmit_packets:sum_rate
            expr: |
              sum by (nodegroup) (
                irate(node_network_transmit_packets_total{device!~"lo|veth.*|docker.*|br.*"}[5m])
                * on(instance) group_left(node)
                label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
                * on(node) group_left(nodegroup)
                label_replace(
                  kube_node_labels{label_theriseunion_io_nodegroup!=""},
                  "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
                )
              )

          # =====================================================
          # Disk metrics (aggregated by nodegroup)
          # =====================================================

          - record: nodegroup:node_filesystem_usage_bytes:sum
            expr: |
              sum by (nodegroup) (
                (node_filesystem_size_bytes - node_filesystem_avail_bytes)
                * on(instance) group_left(node)
                label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
                * on(node) group_left(nodegroup)
                label_replace(
                  kube_node_labels{label_theriseunion_io_nodegroup!=""},
                  "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
                )
              )

          - record: nodegroup:node_filesystem_available_bytes:sum
            expr: |
              sum by (nodegroup) (
                node_filesystem_avail_bytes
                * on(instance) group_left(node)
                label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
                * on(node) group_left(nodegroup)
                label_replace(
                  kube_node_labels{label_theriseunion_io_nodegroup!=""},
                  "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
                )
              )

          - record: nodegroup:node_filesystem_total_bytes:sum
            expr: |
              sum by (nodegroup) (
                node_filesystem_size_bytes
                * on(instance) group_left(node)
                label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
                * on(node) group_left(nodegroup)
                label_replace(
                  kube_node_labels{label_theriseunion_io_nodegroup!=""},
                  "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
                )
              )

          - record: nodegroup:node_disk_reads:sum_rate
            expr: |
              sum by (nodegroup) (
                irate(node_disk_reads_completed_total[5m])
                * on(instance) group_left(node)
                label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
                * on(node) group_left(nodegroup)
                label_replace(
                  kube_node_labels{label_theriseunion_io_nodegroup!=""},
                  "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
                )
              )

          - record: nodegroup:node_disk_writes:sum_rate
            expr: |
              sum by (nodegroup) (
                irate(node_disk_writes_completed_total[5m])
                * on(instance) group_left(node)
                label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
                * on(node) group_left(nodegroup)
                label_replace(
                  kube_node_labels{label_theriseunion_io_nodegroup!=""},
                  "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
                )
              )

          - record: nodegroup:node_disk_read_bytes:sum_rate
            expr: |
              sum by (nodegroup) (
                irate(node_disk_read_bytes_total[5m])
                * on(instance) group_left(node)
                label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
                * on(node) group_left(nodegroup)
                label_replace(
                  kube_node_labels{label_theriseunion_io_nodegroup!=""},
                  "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
                )
              )

          - record: nodegroup:node_disk_written_bytes:sum_rate
            expr: |
              sum by (nodegroup) (
                irate(node_disk_written_bytes_total[5m])
                * on(instance) group_left(node)
                label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
                * on(node) group_left(nodegroup)
                label_replace(
                  kube_node_labels{label_theriseunion_io_nodegroup!=""},
                  "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
                )
              )

          # =====================================================
          # Node load metrics (aggregated by nodegroup)
          # =====================================================

          - record: nodegroup:node_load1:sum
            expr: |
              sum by (nodegroup) (
                node_load1
                * on(instance) group_left(node)
                label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
                * on(node) group_left(nodegroup)
                label_replace(
                  kube_node_labels{label_theriseunion_io_nodegroup!=""},
                  "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
                )
              )

          - record: nodegroup:node_load5:sum
            expr: |
              sum by (nodegroup) (
                node_load5
                * on(instance) group_left(node)
                label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
                * on(node) group_left(nodegroup)
                label_replace(
                  kube_node_labels{label_theriseunion_io_nodegroup!=""},
                  "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
                )
              )

          - record: nodegroup:node_load15:sum
            expr: |
              sum by (nodegroup) (
                node_load15
                * on(instance) group_left(node)
                label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
                * on(node) group_left(nodegroup)
                label_replace(
                  kube_node_labels{label_theriseunion_io_nodegroup!=""},
                  "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
                )
              )

          # =====================================================
          # Resource utilization (calculated by nodegroup)
          # =====================================================

          - record: nodegroup:cpu_utilization_percent
            expr: |
              (
                nodegroup:node_cpu_usage:sum_rate
                /
                nodegroup:machine_cpu_cores:sum
              ) * 100

          - record: nodegroup:memory_utilization_percent
            expr: |
              (
                nodegroup:node_memory_usage_bytes:sum
                /
                nodegroup:node_memory_total_bytes:sum
              ) * 100

          - record: nodegroup:filesystem_utilization_percent
            expr: |
              (
                nodegroup:node_filesystem_usage_bytes:sum
                /
                nodegroup:node_filesystem_total_bytes:sum
              ) * 100

          # ========================================================================
          # Edge Platform Extension: NodeGroup Utilisation Rules (Ratio-based)
          # Added by: Edge Team
          # Purpose: Pre-calculate CPU/Memory utilisation as 0-1 ratios for performance and stability
          # Dependencies: Requires existing nodegroup recording rules (usage, total, etc.)
          # Note: These complement the existing _percent rules (0-100) with ratio format (0-1)
          #       following Prometheus best practices for ratio metrics
          # ========================================================================

          # NodeGroup CPU utilisation (0-1 ratio)
          # Calculates: CPU usage rate / Total CPU cores
          # Example: 4 cores at 50% = 2 cores usage / 4 cores total = 0.5
          - record: nodegroup:node_cpu_utilisation:avg
            expr: |
              nodegroup:node_cpu_usage:sum_rate
              /
              nodegroup:machine_cpu_cores:sum

          # NodeGroup Memory utilisation (0-1 ratio)
          # Calculates: (MemTotal - MemAvailable) / MemTotal
          # Example: 16GB total, 8GB available = (16-8)/16 = 0.5
          - record: nodegroup:node_memory_utilisation:avg
            expr: |
              (nodegroup:node_memory_total_bytes:sum -
               nodegroup:node_memory_available_bytes:sum)
              /
              nodegroup:node_memory_total_bytes:sum

      # ========================================================================
      # Edge Platform Extension: Namespace-level Aggregation Rules
      # Added by: Edge Team
      # Purpose: Pre-aggregate workload counts and metrics by namespace
      # Dependencies: Requires kube-state-metrics
      # Note: These rules are REQUIRED for namespace metrics API to work correctly
      # ========================================================================
      - name: namespace-aggregation-rules
        interval: 30s
        rules:
          # =====================================================
          # Pod and Workload Count (aggregated by namespace)
          # =====================================================

          # Namespace pod count
          - record: namespace:kube_pod:count
            expr: |
              count by (cluster, namespace) (
                kube_pod_info
              )

          # Namespace deployment count
          - record: namespace:kube_deployment:count
            expr: |
              count by (cluster, namespace) (
                kube_deployment_spec_replicas
              )

          # Namespace statefulset count
          - record: namespace:kube_statefulset:count
            expr: |
              count by (cluster, namespace) (
                kube_statefulset_replicas
              )

          # Namespace daemonset count
          - record: namespace:kube_daemonset:count
            expr: |
              count by (cluster, namespace) (
                kube_daemonset_status_desired_number_scheduled
              )

          # Namespace job count
          - record: namespace:kube_job:count
            expr: |
              count by (cluster, namespace) (
                kube_job_info
              )

          # Namespace cronjob count
          - record: namespace:kube_cronjob:count
            expr: |
              count by (cluster, namespace) (
                kube_cronjob_info
              )

          # Namespace service count
          - record: namespace:kube_service:count
            expr: |
              count by (cluster, namespace) (
                kube_service_info
              )

          # =====================================================
          # CPU metrics (aggregated by namespace)
          # =====================================================

          - record: namespace:container_cpu_usage_seconds:sum_rate
            expr: |
              sum by (cluster, namespace) (
                irate(container_cpu_usage_seconds_total{container!="POD", container!="", image!=""}[5m])
              )

          # =====================================================
          # Memory metrics (aggregated by namespace)
          # =====================================================

          - record: namespace:container_memory_usage_bytes:sum
            expr: |
              sum by (cluster, namespace) (
                container_memory_usage_bytes{container!="POD", container!="", image!=""}
              )

          # =====================================================
          # Network metrics (aggregated by namespace)
          # =====================================================

          - record: namespace:container_network_receive_packets:sum_rate
            expr: |
              sum by (cluster, namespace) (
                irate(container_network_receive_packets_total{interface!="lo"}[5m])
              )

          - record: namespace:container_network_transmit_packets:sum_rate
            expr: |
              sum by (cluster, namespace) (
                irate(container_network_transmit_packets_total{interface!="lo"}[5m])
              )
kind: ConfigMap
metadata:
  annotations:
    meta.helm.sh/release-name: edge-monitoring
    meta.helm.sh/release-namespace: observability-system
  creationTimestamp: "2025-12-16T01:09:07Z"
  labels:
    app: edge-prometheus
    app.kubernetes.io/managed-by: Helm
    component: prometheus-rules
  name: edge-prometheus-rules
  namespace: observability-system
  resourceVersion: "79595033"
  uid: 3d17f356-dd92-4c44-b160-305500e39777
