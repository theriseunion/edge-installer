groups:
  # Node-level recording rules for CPU and Memory utilization metrics
  - name: node-resource-utilization-rules
    interval: 30s
    rules:
      # Node-level CPU usage aggregation by node
      - record: node_namespace_pod_container:container_cpu_usage_seconds_total:sum_irate
        expr: |
          sum by (cluster, node) (
            irate(container_cpu_usage_seconds_total{job="kubelet", metrics_path="/metrics/cadvisor", container!="", image!=""}[5m])
          )

      # Node-level memory working set aggregation by node
      - record: node_namespace_pod_container:container_memory_working_set_bytes
        expr: |
          sum by (cluster, node) (
            container_memory_working_set_bytes{job="kubelet", metrics_path="/metrics/cadvisor", container!="", image!=""}
          )

      # CPU requests by node - with fallback handling
      - record: cluster:namespace:pod_cpu:active:kube_pod_container_resource_requests
        expr: |
          sum by (cluster, node) (
            (
              kube_pod_container_resource_requests{job="kube-state-metrics", resource="cpu", unit="core"}
              * on (cluster, namespace, pod) group_left(node)
              kube_pod_info{job="kube-state-metrics"}
            ) or on (cluster, node) (
              # Fallback: use kube_pod_container_resource_requests without unit filter
              sum by (cluster, node) (
                kube_pod_container_resource_requests{job="kube-state-metrics", resource="cpu"}
                * on (cluster, namespace, pod) group_left(node)
                kube_pod_info{job="kube-state-metrics"}
              )
            )
          )

      # CPU limits by node - with fallback handling
      - record: cluster:namespace:pod_cpu:active:kube_pod_container_resource_limits
        expr: |
          sum by (cluster, node) (
            (
              kube_pod_container_resource_limits{job="kube-state-metrics", resource="cpu", unit="core"}
              * on (cluster, namespace, pod) group_left(node)
              kube_pod_info{job="kube-state-metrics"}
            ) or on (cluster, node) (
              # Fallback: use kube_pod_container_resource_limits without unit filter
              sum by (cluster, node) (
                kube_pod_container_resource_limits{job="kube-state-metrics", resource="cpu"}
                * on (cluster, namespace, pod) group_left(node)
                kube_pod_info{job="kube-state-metrics"}
              )
            )
          )

      # Memory requests by node - with fallback handling
      - record: cluster:namespace:pod_memory:active:kube_pod_container_resource_requests
        expr: |
          sum by (cluster, node) (
            (
              kube_pod_container_resource_requests{job="kube-state-metrics", resource="memory", unit="byte"}
              * on (cluster, namespace, pod) group_left(node)
              kube_pod_info{job="kube-state-metrics"}
            ) or on (cluster, node) (
              # Fallback: use kube_pod_container_resource_requests without unit filter
              sum by (cluster, node) (
                kube_pod_container_resource_requests{job="kube-state-metrics", resource="memory"}
                * on (cluster, namespace, pod) group_left(node)
                kube_pod_info{job="kube-state-metrics"}
              )
            )
          )

      # Memory limits by node - with fallback handling
      - record: cluster:namespace:pod_memory:active:kube_pod_container_resource_limits
        expr: |
          sum by (cluster, node) (
            (
              kube_pod_container_resource_limits{job="kube-state-metrics", resource="memory", unit="byte"}
              * on (cluster, namespace, pod) group_left(node)
              kube_pod_info{job="kube-state-metrics"}
            ) or on (cluster, node) (
              # Fallback: use kube_pod_container_resource_limits without unit filter
              sum by (cluster, node) (
                kube_pod_container_resource_limits{job="kube-state-metrics", resource="memory"}
                * on (cluster, namespace, pod) group_left(node)
                kube_pod_info{job="kube-state-metrics"}
              )
            )
          )

  # Additional recording rules for cluster-level aggregations that may be missing
  - name: cluster-resource-aggregation-rules
    interval: 30s
    rules:
      # Cluster-level CPU requests total
      - record: namespace_cpu:kube_pod_container_resource_requests:sum
        expr: |
          sum by (cluster, namespace) (
            kube_pod_container_resource_requests{job="kube-state-metrics", resource="cpu", unit="core"}
          )

      # Cluster-level CPU limits total
      - record: namespace_cpu:kube_pod_container_resource_limits:sum
        expr: |
          sum by (cluster, namespace) (
            kube_pod_container_resource_limits{job="kube-state-metrics", resource="cpu", unit="core"}
          )

      # Cluster-level memory requests total
      - record: namespace_memory:kube_pod_container_resource_requests:sum
        expr: |
          sum by (cluster, namespace) (
            kube_pod_container_resource_requests{job="kube-state-metrics", resource="memory", unit="byte"}
          )

      # Cluster-level memory limits total
      - record: namespace_memory:kube_pod_container_resource_limits:sum
        expr: |
          sum by (cluster, namespace) (
            kube_pod_container_resource_limits{job="kube-state-metrics", resource="memory", unit="byte"}
          )

      # Node memory available bytes
      - record: :node_memory_MemAvailable_bytes:sum
        expr: |
          sum by (cluster, instance) (
            node_memory_MemAvailable_bytes{job="node-exporter"}
          )

  # Workload-level recording rules for namespace_workload_pod metrics
  - name: workload-aggregation-rules
    interval: 30s
    rules:
      # Create workload-level metric with proper labels for cluster workload count
      - record: namespace_workload_pod:kube_pod_owner:relabel
        expr: |
          label_replace(
            kube_pod_info{job="kube-state-metrics"},
            "workload",
            "$1",
            "created_by_name",
            "(.*)"
          )

  # Workspace-level aggregation recording rules
  - name: workspace-aggregation-rules
    interval: 30s
    rules:
      # =====================================================
      # CPU metrics (aggregated by workspace)
      # =====================================================

      - record: workspace:container_cpu_usage_seconds:sum_rate
        expr: |
          sum by (workspace) (
            irate(container_cpu_usage_seconds_total{container!="POD", container!="", image!=""}[5m])
            * on(namespace) group_left(workspace)
            label_replace(
              kube_namespace_labels{label_theriseunion_io_workspace!=""},
              "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
            )
          )

      # =====================================================
      # Memory metrics (aggregated by workspace)
      # =====================================================

      - record: workspace:container_memory_usage_bytes:sum
        expr: |
          sum by (workspace) (
            container_memory_usage_bytes{container!="POD", container!="", image!=""}
            * on(namespace) group_left(workspace)
            label_replace(
              kube_namespace_labels{label_theriseunion_io_workspace!=""},
              "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
            )
          )

      - record: workspace:container_memory_rss:sum
        expr: |
          sum by (workspace) (
            container_memory_rss{container!="POD", container!="", image!=""}
            * on(namespace) group_left(workspace)
            label_replace(
              kube_namespace_labels{label_theriseunion_io_workspace!=""},
              "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
            )
          )

      # =====================================================
      # Pod count (aggregated by workspace)
      # =====================================================

      - record: workspace:kube_pod_info:count
        expr: |
          count by (workspace) (
            kube_pod_info
            * on(namespace) group_left(workspace)
            label_replace(
              kube_namespace_labels{label_theriseunion_io_workspace!=""},
              "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
            )
          )

      # =====================================================
      # Namespace count (aggregated by workspace)
      # =====================================================

      - record: workspace:kube_namespace:count
        expr: |
          count by (workspace) (
            label_replace(
              kube_namespace_labels{label_theriseunion_io_workspace!=""},
              "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
            )
          )

      # =====================================================
      # Network metrics (aggregated by workspace)
      # =====================================================

      - record: workspace:container_network_receive_bytes:sum_rate
        expr: |
          sum by (workspace) (
            irate(container_network_receive_bytes_total{interface!="lo"}[5m])
            * on(namespace) group_left(workspace)
            label_replace(
              kube_namespace_labels{label_theriseunion_io_workspace!=""},
              "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
            )
          )

      - record: workspace:container_network_transmit_bytes:sum_rate
        expr: |
          sum by (workspace) (
            irate(container_network_transmit_bytes_total{interface!="lo"}[5m])
            * on(namespace) group_left(workspace)
            label_replace(
              kube_namespace_labels{label_theriseunion_io_workspace!=""},
              "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
            )
          )

      - record: workspace:container_network_receive_packets:sum_rate
        expr: |
          sum by (workspace) (
            irate(container_network_receive_packets_total{interface!="lo"}[5m])
            * on(namespace) group_left(workspace)
            label_replace(
              kube_namespace_labels{label_theriseunion_io_workspace!=""},
              "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
            )
          )

      - record: workspace:container_network_transmit_packets:sum_rate
        expr: |
          sum by (workspace) (
            irate(container_network_transmit_packets_total{interface!="lo"}[5m])
            * on(namespace) group_left(workspace)
            label_replace(
              kube_namespace_labels{label_theriseunion_io_workspace!=""},
              "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
            )
          )

      # =====================================================
      # Disk I/O metrics (aggregated by workspace)
      # =====================================================

      - record: workspace:container_fs_reads:sum_rate
        expr: |
          sum by (workspace) (
            irate(container_fs_reads_total[5m])
            * on(namespace) group_left(workspace)
            label_replace(
              kube_namespace_labels{label_theriseunion_io_workspace!=""},
              "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
            )
          )

      - record: workspace:container_fs_writes:sum_rate
        expr: |
          sum by (workspace) (
            irate(container_fs_writes_total[5m])
            * on(namespace) group_left(workspace)
            label_replace(
              kube_namespace_labels{label_theriseunion_io_workspace!=""},
              "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
            )
          )

      - record: workspace:container_fs_reads_bytes:sum_rate
        expr: |
          sum by (workspace) (
            irate(container_fs_reads_bytes_total[5m])
            * on(namespace) group_left(workspace)
            label_replace(
              kube_namespace_labels{label_theriseunion_io_workspace!=""},
              "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
            )
          )

      - record: workspace:container_fs_writes_bytes:sum_rate
        expr: |
          sum by (workspace) (
            irate(container_fs_writes_bytes_total[5m])
            * on(namespace) group_left(workspace)
            label_replace(
              kube_namespace_labels{label_theriseunion_io_workspace!=""},
              "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
            )
          )

      # =====================================================
      # Resource Requests/Limits (aggregated by workspace)
      # =====================================================

      - record: workspace:kube_pod_container_resource_requests_memory:sum
        expr: |
          sum by (workspace) (
            kube_pod_container_resource_requests{resource="memory"}
            * on(namespace) group_left(workspace)
            label_replace(
              kube_namespace_labels{label_theriseunion_io_workspace!=""},
              "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
            )
          )

      - record: workspace:kube_pod_container_resource_limits_memory:sum
        expr: |
          sum by (workspace) (
            kube_pod_container_resource_limits{resource="memory"}
            * on(namespace) group_left(workspace)
            label_replace(
              kube_namespace_labels{label_theriseunion_io_workspace!=""},
              "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
            )
          )

      - record: workspace:kube_pod_container_resource_requests_cpu:sum
        expr: |
          sum by (workspace) (
            kube_pod_container_resource_requests{resource="cpu"}
            * on(namespace) group_left(workspace)
            label_replace(
              kube_namespace_labels{label_theriseunion_io_workspace!=""},
              "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
            )
          )

      - record: workspace:kube_pod_container_resource_limits_cpu:sum
        expr: |
          sum by (workspace) (
            kube_pod_container_resource_limits{resource="cpu"}
            * on(namespace) group_left(workspace)
            label_replace(
              kube_namespace_labels{label_theriseunion_io_workspace!=""},
              "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
            )
          )

      # ========================================================================
      # Edge Platform Extension: Workspace Workload Count Rules
      # Added by: Edge Team
      # Purpose: Pre-aggregate workload counts by workspace for performance
      # Dependencies: Requires kube-state-metrics with custom labels
      # ========================================================================

      # Workspace deployment count
      - record: workspace:kube_deployment:count
        expr: |
          count by (workspace) (
            kube_deployment_spec_replicas
            * on(namespace) group_left(workspace)
            label_replace(
              kube_namespace_labels{label_theriseunion_io_workspace!=""},
              "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
            )
          )

      # Workspace statefulset count
      - record: workspace:kube_statefulset:count
        expr: |
          count by (workspace) (
            kube_statefulset_replicas
            * on(namespace) group_left(workspace)
            label_replace(
              kube_namespace_labels{label_theriseunion_io_workspace!=""},
              "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
            )
          )

      # Workspace daemonset count
      - record: workspace:kube_daemonset:count
        expr: |
          count by (workspace) (
            kube_daemonset_status_desired_number_scheduled
            * on(namespace) group_left(workspace)
            label_replace(
              kube_namespace_labels{label_theriseunion_io_workspace!=""},
              "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
            )
          )

      # Workspace job count
      - record: workspace:kube_job:count
        expr: |
          count by (workspace) (
            kube_job_info
            * on(namespace) group_left(workspace)
            label_replace(
              kube_namespace_labels{label_theriseunion_io_workspace!=""},
              "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
            )
          )

      # Workspace cronjob count
      - record: workspace:kube_cronjob:count
        expr: |
          count by (workspace) (
            kube_cronjob_info
            * on(namespace) group_left(workspace)
            label_replace(
              kube_namespace_labels{label_theriseunion_io_workspace!=""},
              "workspace", "$1", "label_theriseunion_io_workspace", "(.*)"
            )
          )

      # =====================================================
      # Resource utilization (calculated by workspace)
      # =====================================================

      - record: workspace:memory_utilization_percent
        expr: |
          (
            workspace:container_memory_usage_bytes:sum
            /
            workspace:kube_pod_container_resource_requests_memory:sum
          ) * 100

      - record: workspace:cpu_utilization_percent
        expr: |
          (
            workspace:container_cpu_usage_seconds:sum_rate
            /
            workspace:kube_pod_container_resource_requests_cpu:sum
          ) * 100

  # NodeGroup-level aggregation recording rules
  - name: nodegroup-aggregation-rules
    interval: 30s
    rules:
      # =====================================================
      # Node count (aggregated by nodegroup)
      # =====================================================

      - record: nodegroup:kube_node_info:count
        expr: |
          count by (nodegroup) (
            kube_node_info
            * on(node) group_left(nodegroup)
            label_replace(
              kube_node_labels{label_theriseunion_io_nodegroup!=""},
              "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
            )
          )

      # =====================================================
      # CPU metrics (aggregated by nodegroup)
      # =====================================================

      - record: nodegroup:node_cpu_usage:sum_rate
        expr: |
          sum by (nodegroup) (
            (1 - avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])))
            * on(instance) group_left(node)
            label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
            * on(node) group_left(nodegroup)
            label_replace(
              kube_node_labels{label_theriseunion_io_nodegroup!=""},
              "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
            )
          )

      - record: nodegroup:machine_cpu_cores:sum
        expr: |
          sum by (nodegroup) (
            machine_cpu_cores
            * on(instance) group_left(node)
            label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
            * on(node) group_left(nodegroup)
            label_replace(
              kube_node_labels{label_theriseunion_io_nodegroup!=""},
              "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
            )
          )

      # =====================================================
      # Memory metrics (aggregated by nodegroup)
      # =====================================================

      - record: nodegroup:node_memory_usage_bytes:sum
        expr: |
          sum by (nodegroup) (
            (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes)
            * on(instance) group_left(node)
            label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
            * on(node) group_left(nodegroup)
            label_replace(
              kube_node_labels{label_theriseunion_io_nodegroup!=""},
              "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
            )
          )

      - record: nodegroup:node_memory_available_bytes:sum
        expr: |
          sum by (nodegroup) (
            node_memory_MemAvailable_bytes
            * on(instance) group_left(node)
            label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
            * on(node) group_left(nodegroup)
            label_replace(
              kube_node_labels{label_theriseunion_io_nodegroup!=""},
              "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
            )
          )

      - record: nodegroup:node_memory_total_bytes:sum
        expr: |
          sum by (nodegroup) (
            node_memory_MemTotal_bytes
            * on(instance) group_left(node)
            label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
            * on(node) group_left(nodegroup)
            label_replace(
              kube_node_labels{label_theriseunion_io_nodegroup!=""},
              "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
            )
          )

      # =====================================================
      # Network metrics (aggregated by nodegroup)
      # =====================================================

      - record: nodegroup:node_network_receive_bytes:sum_rate
        expr: |
          sum by (nodegroup) (
            irate(node_network_receive_bytes_total{device!~"lo|veth.*|docker.*|br.*"}[5m])
            * on(instance) group_left(node)
            label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
            * on(node) group_left(nodegroup)
            label_replace(
              kube_node_labels{label_theriseunion_io_nodegroup!=""},
              "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
            )
          )

      - record: nodegroup:node_network_transmit_bytes:sum_rate
        expr: |
          sum by (nodegroup) (
            irate(node_network_transmit_bytes_total{device!~"lo|veth.*|docker.*|br.*"}[5m])
            * on(instance) group_left(node)
            label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
            * on(node) group_left(nodegroup)
            label_replace(
              kube_node_labels{label_theriseunion_io_nodegroup!=""},
              "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
            )
          )

      - record: nodegroup:node_network_receive_packets:sum_rate
        expr: |
          sum by (nodegroup) (
            irate(node_network_receive_packets_total{device!~"lo|veth.*|docker.*|br.*"}[5m])
            * on(instance) group_left(node)
            label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
            * on(node) group_left(nodegroup)
            label_replace(
              kube_node_labels{label_theriseunion_io_nodegroup!=""},
              "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
            )
          )

      - record: nodegroup:node_network_transmit_packets:sum_rate
        expr: |
          sum by (nodegroup) (
            irate(node_network_transmit_packets_total{device!~"lo|veth.*|docker.*|br.*"}[5m])
            * on(instance) group_left(node)
            label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
            * on(node) group_left(nodegroup)
            label_replace(
              kube_node_labels{label_theriseunion_io_nodegroup!=""},
              "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
            )
          )

      # =====================================================
      # Disk metrics (aggregated by nodegroup)
      # =====================================================

      - record: nodegroup:node_filesystem_usage_bytes:sum
        expr: |
          sum by (nodegroup) (
            (node_filesystem_size_bytes - node_filesystem_avail_bytes)
            * on(instance) group_left(node)
            label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
            * on(node) group_left(nodegroup)
            label_replace(
              kube_node_labels{label_theriseunion_io_nodegroup!=""},
              "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
            )
          )

      - record: nodegroup:node_filesystem_available_bytes:sum
        expr: |
          sum by (nodegroup) (
            node_filesystem_avail_bytes
            * on(instance) group_left(node)
            label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
            * on(node) group_left(nodegroup)
            label_replace(
              kube_node_labels{label_theriseunion_io_nodegroup!=""},
              "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
            )
          )

      - record: nodegroup:node_filesystem_total_bytes:sum
        expr: |
          sum by (nodegroup) (
            node_filesystem_size_bytes
            * on(instance) group_left(node)
            label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
            * on(node) group_left(nodegroup)
            label_replace(
              kube_node_labels{label_theriseunion_io_nodegroup!=""},
              "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
            )
          )

      - record: nodegroup:node_disk_reads:sum_rate
        expr: |
          sum by (nodegroup) (
            irate(node_disk_reads_completed_total[5m])
            * on(instance) group_left(node)
            label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
            * on(node) group_left(nodegroup)
            label_replace(
              kube_node_labels{label_theriseunion_io_nodegroup!=""},
              "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
            )
          )

      - record: nodegroup:node_disk_writes:sum_rate
        expr: |
          sum by (nodegroup) (
            irate(node_disk_writes_completed_total[5m])
            * on(instance) group_left(node)
            label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
            * on(node) group_left(nodegroup)
            label_replace(
              kube_node_labels{label_theriseunion_io_nodegroup!=""},
              "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
            )
          )

      - record: nodegroup:node_disk_read_bytes:sum_rate
        expr: |
          sum by (nodegroup) (
            irate(node_disk_read_bytes_total[5m])
            * on(instance) group_left(node)
            label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
            * on(node) group_left(nodegroup)
            label_replace(
              kube_node_labels{label_theriseunion_io_nodegroup!=""},
              "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
            )
          )

      - record: nodegroup:node_disk_written_bytes:sum_rate
        expr: |
          sum by (nodegroup) (
            irate(node_disk_written_bytes_total[5m])
            * on(instance) group_left(node)
            label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
            * on(node) group_left(nodegroup)
            label_replace(
              kube_node_labels{label_theriseunion_io_nodegroup!=""},
              "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
            )
          )

      # =====================================================
      # Node load metrics (aggregated by nodegroup)
      # =====================================================

      - record: nodegroup:node_load1:sum
        expr: |
          sum by (nodegroup) (
            node_load1
            * on(instance) group_left(node)
            label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
            * on(node) group_left(nodegroup)
            label_replace(
              kube_node_labels{label_theriseunion_io_nodegroup!=""},
              "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
            )
          )

      - record: nodegroup:node_load5:sum
        expr: |
          sum by (nodegroup) (
            node_load5
            * on(instance) group_left(node)
            label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
            * on(node) group_left(nodegroup)
            label_replace(
              kube_node_labels{label_theriseunion_io_nodegroup!=""},
              "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
            )
          )

      - record: nodegroup:node_load15:sum
        expr: |
          sum by (nodegroup) (
            node_load15
            * on(instance) group_left(node)
            label_replace(kube_node_info, "instance", "$1", "node", "(.*)")
            * on(node) group_left(nodegroup)
            label_replace(
              kube_node_labels{label_theriseunion_io_nodegroup!=""},
              "nodegroup", "$1", "label_theriseunion_io_nodegroup", "(.*)"
            )
          )

      # =====================================================
      # Resource utilization (calculated by nodegroup)
      # =====================================================

      - record: nodegroup:cpu_utilization_percent
        expr: |
          (
            nodegroup:node_cpu_usage:sum_rate
            /
            nodegroup:machine_cpu_cores:sum
          ) * 100

      - record: nodegroup:memory_utilization_percent
        expr: |
          (
            nodegroup:node_memory_usage_bytes:sum
            /
            nodegroup:node_memory_total_bytes:sum
          ) * 100

      - record: nodegroup:filesystem_utilization_percent
        expr: |
          (
            nodegroup:node_filesystem_usage_bytes:sum
            /
            nodegroup:node_filesystem_total_bytes:sum
          ) * 100

      # ========================================================================
      # Edge Platform Extension: NodeGroup Utilisation Rules (Ratio-based)
      # Added by: Edge Team
      # Purpose: Pre-calculate CPU/Memory utilisation as 0-1 ratios for performance and stability
      # Dependencies: Requires existing nodegroup recording rules (usage, total, etc.)
      # Note: These complement the existing _percent rules (0-100) with ratio format (0-1)
      #       following Prometheus best practices for ratio metrics
      # ========================================================================

      # NodeGroup CPU utilisation (0-1 ratio)
      # Calculates: CPU usage rate / Total CPU cores
      # Example: 4 cores at 50% = 2 cores usage / 4 cores total = 0.5
      - record: nodegroup:node_cpu_utilisation:avg
        expr: |
          nodegroup:node_cpu_usage:sum_rate
          /
          nodegroup:machine_cpu_cores:sum

      # NodeGroup Memory utilisation (0-1 ratio)
      # Calculates: (MemTotal - MemAvailable) / MemTotal
      # Example: 16GB total, 8GB available = (16-8)/16 = 0.5
      - record: nodegroup:node_memory_utilisation:avg
        expr: |
          (nodegroup:node_memory_total_bytes:sum -
           nodegroup:node_memory_available_bytes:sum)
          /
          nodegroup:node_memory_total_bytes:sum

  # ========================================================================
  # Edge Platform Extension: Namespace-level Aggregation Rules
  # Added by: Edge Team
  # Purpose: Pre-aggregate workload counts and metrics by namespace
  # Dependencies: Requires kube-state-metrics
  # Note: These rules are REQUIRED for namespace metrics API to work correctly
  # ========================================================================
  - name: namespace-aggregation-rules
    interval: 30s
    rules:
      # =====================================================
      # Pod and Workload Count (aggregated by namespace)
      # =====================================================

      # Namespace pod count
      - record: namespace:kube_pod:count
        expr: |
          count by (cluster, namespace) (
            kube_pod_info
          )

      # Namespace deployment count
      - record: namespace:kube_deployment:count
        expr: |
          count by (cluster, namespace) (
            kube_deployment_spec_replicas
          )

      # Namespace statefulset count
      - record: namespace:kube_statefulset:count
        expr: |
          count by (cluster, namespace) (
            kube_statefulset_replicas
          )

      # Namespace daemonset count
      - record: namespace:kube_daemonset:count
        expr: |
          count by (cluster, namespace) (
            kube_daemonset_status_desired_number_scheduled
          )

      # Namespace job count
      - record: namespace:kube_job:count
        expr: |
          count by (cluster, namespace) (
            kube_job_info
          )

      # Namespace cronjob count
      - record: namespace:kube_cronjob:count
        expr: |
          count by (cluster, namespace) (
            kube_cronjob_info
          )

      # Namespace service count
      - record: namespace:kube_service:count
        expr: |
          count by (cluster, namespace) (
            kube_service_info
          )

      # =====================================================
      # CPU metrics (aggregated by namespace)
      # =====================================================

      - record: namespace:container_cpu_usage_seconds:sum_rate
        expr: |
          sum by (cluster, namespace) (
            irate(container_cpu_usage_seconds_total{container!="POD", container!="", image!=""}[5m])
          )

      # =====================================================
      # Memory metrics (aggregated by namespace)
      # =====================================================

      - record: namespace:container_memory_usage_bytes:sum
        expr: |
          sum by (cluster, namespace) (
            container_memory_usage_bytes{container!="POD", container!="", image!=""}
          )

      # =====================================================
      # Network metrics (aggregated by namespace)
      # =====================================================

      - record: namespace:container_network_receive_packets:sum_rate
        expr: |
          sum by (cluster, namespace) (
            irate(container_network_receive_packets_total{interface!="lo"}[5m])
          )

      - record: namespace:container_network_transmit_packets:sum_rate
        expr: |
          sum by (cluster, namespace) (
            irate(container_network_transmit_packets_total{interface!="lo"}[5m])
          )

  # ========================================================================
  # Cluster-level Aggregation Rules
  # Added by: Edge Team
  # Purpose: Pre-aggregate metrics across entire cluster for time-series charts
  # Dependencies: Requires kube-state-metrics and cadvisor metrics
  # Note: These metrics are used by the cluster overview page time-series charts
  # ========================================================================
  - name: cluster-aggregation-rules
    interval: 30s
    rules:
      # =====================================================
      # Cluster CPU metrics (aggregated across entire cluster)
      # =====================================================

      # Cluster CPU usage (cores) - uses node-level metrics for accurate physical CPU usage
      - record: cluster_cpu_usage
        expr: |
          sum (
            rate(node_cpu_seconds_total{mode!="idle", mode!="iowait", mode!="steal"}[5m])
          )

      # Cluster CPU utilisation (percentage) - physical CPU / total CPU cores
      - record: cluster_cpu_utilisation
        expr: |
          sum (
            rate(node_cpu_seconds_total{mode!="idle", mode!="iowait", mode!="steal"}[5m])
          ) / sum (
            machine_cpu_cores
          )

      # Cluster total CPU cores available
      - record: cluster_cpu_total
        expr: |
          sum (
            machine_cpu_cores
          )

      # =====================================================
      # Cluster Memory metrics (aggregated across entire cluster)
      # =====================================================

      # Cluster memory usage (bytes) - uses node-level metrics for accurate physical memory usage
      - record: cluster_memory_usage
        expr: |
          sum (
            node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes
          )

      # Cluster memory utilisation (percentage) - physical memory / total memory
      - record: cluster_memory_utilisation
        expr: |
          sum (
            node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes
          ) / sum (
            node_memory_MemTotal_bytes
          )

      # Cluster total memory available (bytes)
      - record: cluster_memory_total
        expr: |
          sum (
            node_memory_MemTotal_bytes
          )

      # =====================================================
      # Cluster Disk metrics (aggregated across entire cluster)
      # =====================================================

      # Cluster disk usage (bytes)
      - record: cluster_disk_size_usage
        expr: |
          sum (
            node_filesystem_size_bytes{mountpoint="/"} - node_filesystem_avail_bytes{mountpoint="/"}
          )

      # Cluster disk utilisation (percentage)
      - record: cluster_disk_size_utilisation
        expr: |
          sum (
            node_filesystem_size_bytes{mountpoint="/"} - node_filesystem_avail_bytes{mountpoint="/"}
          ) / sum (
            node_filesystem_size_bytes{mountpoint="/"}
          )

      # Cluster total disk available (bytes)
      - record: cluster_disk_size_total
        expr: |
          sum (
            node_filesystem_size_bytes{mountpoint="/"}
          )

      # =====================================================
      # Cluster GPU metrics (aggregated across entire cluster)
      # =====================================================

      # Cluster GPU usage (placeholder - will be 0 if no GPUs)
      - record: cluster_gpu_usage
        expr: |
          sum (
            device_gpu_utilization_percent
          ) or vector(0)

      # Cluster GPU total (placeholder - will be 0 if no GPUs)
      - record: cluster_gpu_total
        expr: |
          count (
            device_gpu_utilization_percent
          ) or vector(0)

      # =====================================================
      # Cluster Pod and Resource Count metrics
      # =====================================================

      # Cluster total pod count
      - record: cluster_pod_count
        expr: |
          sum (
            kube_pod_info
          )

      # Cluster total node count
      - record: cluster_node_count
        expr: |
          sum (
            kube_node_info
          )

      # Cluster total namespace count
      - record: cluster_namespace_count
        expr: |
          sum (
            kube_namespace_labels
          )groups:
  # vLLM service monitoring recording rules
  - name: vllm-service-monitoring-rules
    interval: 30s
    rules:
      # 1. 端到端时延平均值 (E2E Request Latency Average)
      - record: vllm:e2e_request_latency_seconds:avg
        expr: |
          rate(vllm:e2e_request_latency_seconds_sum[5m])
          /
          rate(vllm:e2e_request_latency_seconds_count[5m])

      # 1.1 端到端时延 P50
      - record: vllm:e2e_request_latency_seconds:p50
        expr: |
          histogram_quantile(0.50, rate(vllm:e2e_request_latency_seconds_bucket[5m]))

      # 1.2 端到端时延 P95
      - record: vllm:e2e_request_latency_seconds:p95
        expr: |
          histogram_quantile(0.95, rate(vllm:e2e_request_latency_seconds_bucket[5m]))

      # 1.3 端到端时延 P99
      - record: vllm:e2e_request_latency_seconds:p99
        expr: |
          histogram_quantile(0.99, rate(vllm:e2e_request_latency_seconds_bucket[5m]))

      # 2. 生成第一个词所需时间平均值 (Time to First Token - TTFT Average)
      - record: vllm:time_to_first_token_seconds:avg
        expr: |
          rate(vllm:time_to_first_token_seconds_sum[5m])
          /
          rate(vllm:time_to_first_token_seconds_count[5m])

      # 2.1 生成第一个词所需时间 P50
      - record: vllm:time_to_first_token_seconds:p50
        expr: |
          histogram_quantile(0.50, rate(vllm:time_to_first_token_seconds_bucket[5m]))

      # 2.2 生成第一个词所需时间 P95
      - record: vllm:time_to_first_token_seconds:p95
        expr: |
          histogram_quantile(0.95, rate(vllm:time_to_first_token_seconds_bucket[5m]))

      # 2.3 生成第一个词所需时间 P99
      - record: vllm:time_to_first_token_seconds:p99
        expr: |
          histogram_quantile(0.99, rate(vllm:time_to_first_token_seconds_bucket[5m]))

      # 3. 输入阶段的平均吞吐量 (Prompt Tokens Throughput - tokens/s)
      - record: vllm:prompt_tokens_throughput:rate
        expr: |
          rate(vllm:prompt_tokens_total[5m])

      # 4. 输出阶段的平均吞吐量 (Generation Tokens Throughput - tokens/s)
      - record: vllm:generation_tokens_throughput:rate
        expr: |
          rate(vllm:generation_tokens_total[5m])

      # 5. 处理请求的总 token 数 (Total Prompt Tokens)
      # 注意：这个是累计值，通常不需要 recording rule，直接使用原始指标即可
      # 如果需要查看增长率，可以使用以下规则
      - record: vllm:prompt_tokens_total:increase_1h
        expr: |
          increase(vllm:prompt_tokens_total[1h])

      # 6. 处理响应的总 token 数 (Total Generation Tokens)
      # 注意：这个是累计值，通常不需要 recording rule，直接使用原始指标即可
      # 如果需要查看增长率，可以使用以下规则
      - record: vllm:generation_tokens_total:increase_1h
        expr: |
          increase(vllm:generation_tokens_total[1h])

      # 额外有用的指标

      # 请求速率 (Requests per second)
      - record: vllm:request_rate:rate
        expr: |
          rate(vllm:e2e_request_latency_seconds_count[5m])

      # 总吞吐量 (Total Tokens Throughput - tokens/s)
      - record: vllm:total_tokens_throughput:rate
        expr: |
          rate(vllm:prompt_tokens_total[5m]) + rate(vllm:generation_tokens_total[5m])

      # 平均每请求的 prompt tokens 数
      - record: vllm:avg_prompt_tokens_per_request
        expr: |
          rate(vllm:prompt_tokens_total[5m])
          /
          rate(vllm:e2e_request_latency_seconds_count[5m])

      # 平均每请求的 generation tokens 数
      - record: vllm:avg_generation_tokens_per_request
        expr: |
          rate(vllm:generation_tokens_total[5m])
          /
          rate(vllm:e2e_request_latency_seconds_count[5m])
