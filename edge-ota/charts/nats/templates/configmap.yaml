apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "nats.fullname" . }}-config
  labels:
    {{- include "nats.labels" . | nindent 4 }}
data:
  nats.conf: |
    # NATS Server Configuration for Edge-OTA
    # Supports both NATS native protocol and MQTT

    # Server identification
    server_name: {{ .Values.nats.serverName }}

    # Listening ports
    port: {{ .Values.service.natsPort }}
    http_port: {{ .Values.service.monitoringPort }}

    # JetStream is required for MQTT support
    jetstream {
      store_dir: /data/jetstream
      max_mem: 64M
      max_file: 1G
    }

    {{- if .Values.mqtt.enabled }}
    # MQTT Configuration
    mqtt {
      port: {{ .Values.mqtt.port }}

      # No TLS for development (enable in production)
      # tls {
      #   cert_file: "/etc/nats/certs/tls.crt"
      #   key_file: "/etc/nats/certs/tls.key"
      # }
    }
    {{- end }}

    # Logging
    debug: {{ .Values.nats.debug }}
    trace: {{ .Values.nats.trace }}
    logtime: true

    # Limits
    max_payload: {{ .Values.nats.maxPayload }}
    max_pending: {{ .Values.nats.maxPending }}
    max_connections: {{ .Values.nats.maxConnections }}

    # Ping/Pong for connection health
    ping_interval: {{ .Values.nats.pingInterval }}
    ping_max: 3

    # Write deadline for slow consumers
    write_deadline: {{ .Values.nats.writeDeadline }}
